---
title: "Supplementary Appendix: Trends in age-standardized mortality rates for blacks and whites by cause and sex, 1969-2013, United States"
output: html_document
---

This is the supplementary appendix for the paper, "Historical trends in the contribution of six major causes of death to the black-white life expectancy gap by US state."

Corinne A Riddell, PhD; Kathryn T Morrison, PhD; Sam Harper, PhD; Jay S Kaufman, PhD

Address correspondence to: Corinne Riddell, PhD, Department of Epidemiology, Biostatistics & Occupational Health, McGill University, 1020 Pine Avenue West, Room 36B, Montreal, QC H3A 1A2, Canada. Email: <corinne.riddell@mail.mcgill.ca>

```{r load_libraries, echo=FALSE, warning=F, message=F}
library(dplyr)
library(purrr)
library(ggplot2)
library(stringr)
library(reshape2)
library(grid)
library(gridExtra)
library(plotly)
library(forcats)
source("./Code/life_expectancy_functions.R")

mortality.rates <- read.csv("./Results/mortality_rates_combined.csv")
mortality.rates.diff <- read.csv("./Results/mortality_rates_diff_combined.csv")

mortality.rates <- mortality.rates %>% mutate(state.reorder = reorder(state, as.numeric(Census_Division))) %>% rename(Race = race)
mortality.rates.diff <- mortality.rates.diff %>% mutate(state.reorder = reorder(state, as.numeric(Census_Division))) 

#DC state abbreviation wasn't accurately defined. Adding it here.
levels(mortality.rates$stabbrs) <- c(levels(mortality.rates$stabbrs), "DC")
levels(mortality.rates.diff$stabbrs) <- c(levels(mortality.rates.diff$stabbrs), "DC")
mortality.rates$stabbrs[mortality.rates$state == "Washington DC"] <- "DC"
mortality.rates.diff$stabbrs[mortality.rates.diff$state == "Washington DC"] <- "DC"

mortality.rates <- reorder.as.map2(mortality.rates, "state", "stabbrs")
mortality.rates.diff <- reorder.as.map2(mortality.rates.diff, "state", "stabbrs")
```

```{r plotting_fx, echo = F}
plot.mortality.trends <- function(dataset, dataset2, COD1, sex1) {
  subset.data <- subset(dataset, COD == COD1 & sex == sex1)
  #lim.y <- c(min(subset.data$rate.per.100k_lcl), max(subset.data$rate.per.100k_ucl))
  
  subset.data2 <- subset(dataset2, sex == sex1 & COD == COD1)
  #lim.y2 <- c(min(subset.data2$rate.difference_LCL), max(subset.data2$rate.difference_UCL))
    
  a <- ggplot(subset.data, aes(x = year, y = rate.per.100k_mean)) + 
              geom_ribbon(aes(ymin = rate.per.100k_lcl, ymax = rate.per.100k_ucl, group = Race), fill = "grey", col = NA, alpha = 0.5) +
              geom_line(aes(col = Race)) +
              facet_wrap( ~ stabbrs.map.order, ncol = 11, drop = F) +
              xlab("Year (1969-2013)") + 
              ylab("Age-standardized mortality rate (per 100,000)") + 
              geom_hline(aes(yintercept = 0)) + geom_vline(aes(xintercept = 1969)) +  
              theme_classic(base_size = 10) +
              theme(axis.text.x = element_blank(),
                    strip.background=element_blank(),
                    axis.line=element_blank(),
                    axis.ticks=element_blank()) 
   
  b <- ggplot(subset.data2, aes(x = year, y = rate.difference_mean)) +
              geom_line() +
              geom_ribbon(aes(ymin = rate.difference_LCL, ymax = rate.difference_UCL), col = NA, alpha = 0.5) +
              facet_wrap( ~ stabbrs.map.order, ncol = 11, drop = F) +
              xlab("Year (1969-2013)") + 
              ylab("Excess mortality among blacks (per 100,000)") +
              geom_hline(aes(yintercept = 0)) + geom_vline(aes(xintercept = 1969)) +  
              #ggtitle(paste0("Excess mortality among blacks (per 100,000) in ", sex1, " for ", COD1)) +
              theme_classic(base_size = 10) +
              theme(panel.grid.minor = element_blank(),
                    axis.text.x = element_blank(),
                    strip.background=element_blank(),
                    axis.line=element_blank(),
                    axis.ticks=element_blank()) 
  
  c <- ggplotly(a)
  d <- ggplotly(b)
  
  for(i in 1:length(c$x$data)){
    if (c$x$data[[i]]$line$color == "rgba(0,0,0,1)") {
      c$x$data[[i]]$hoverinfo <- "none"
    }
    
    c$x$data[[i]]$line$width <- 1 #make all the lines thin
    c$x$data[[i]]$text <- gsub("rate.per.100k_mean", "Mean mortality rate", c$x$data[[i]]$text)
    c$x$data[[i]]$text <- gsub("rate.per.100k_lcl", "Lower credible limit", c$x$data[[i]]$text)
    c$x$data[[i]]$text <- gsub("rate.per.100k_ucl", "Upper credible limit", c$x$data[[i]]$text)
  }
  
  for(i in 1:length(d$x$data)){
    if (d$x$data[[i]]$line$color == "rgba(0,0,0,1)") {
      d$x$data[[i]]$hoverinfo <- "none"
    }
    
    d$x$data[[i]]$line$width <- 1 #make all the lines thin
    d$x$data[[i]]$text <- gsub("rate.difference_mean", "Mean excess mortality", d$x$data[[i]]$text)
    d$x$data[[i]]$text <- gsub("rate.difference_LCL", "Lower credible limit", d$x$data[[i]]$text)
    d$x$data[[i]]$text <- gsub("rate.difference_UCL", "Upper credible limit", d$x$data[[i]]$text)
  }           
  
    return(list(plot1 = a, plot2 = b, plot3 = c, plot4 = d))
}
```

```{r create-the-plots, echo = F, message = F}
for(COD_i in levels(mortality.rates$COD)) {
  for(sex_i in levels(mortality.rates$sex)) {
    assign(paste0(COD_i, ".", sex_i, ".mort.plot"), plot.mortality.trends(dataset = mortality.rates, dataset2 = mortality.rates.diff,
                                                                         COD1 = COD_i, sex1 = sex_i))
  }
}
```

**Figure S3: Age-standardized trends in CVD-related mortality in black and white men, United States, 1969-2013**

```{r print-em, fig.width = 9, fig.height = 7, echo = F}
Cardiovascular.Male.mort.plot[[3]] %>% layout(margin = list(b = 100, l = 70))
#Cardiovascular.Male.mort.plot[[4]]
```

**Figure S4: Age-standardized trends in CVD-related mortality in black and white women, United States, 1969-2013**

```{r print-em-2, fig.width = 9, fig.height = 7, echo = F}
Cardiovascular.Female.mort.plot[[3]] %>% layout(margin = list(b = 100, l = 70))
#Cardiovascular.Female.mort.plot[[4]]
```

**Figure S5: Age-standardized trends in cancer-related mortality in black and white men, United States, 1969-2013**

```{r print-em-3, fig.width = 9, fig.height = 7, echo = F}
Cancers.Male.mort.plot[[3]] %>% layout(margin = list(b = 100, l = 70))
#Cancers.Male.mort.plot[[4]]
```

**Figure S6: Age-standardized trends in cancer-related mortality in black and white women, United States, 1969-2013**

```{r print-em-4, fig.width = 9, fig.height = 7, echo = F}
Cancers.Female.mort.plot[[3]] %>% layout(margin = list(b = 100, l = 70))
#Cancers.Female.mort.plot[[4]]
```

**Figure S7: Age-standardized trends in mortality related to non-communicable disease in black and white men, United States, 1969-2013**

```{r, fig.width = 9, fig.height = 7, echo = F}
`Non-communicable.Male.mort.plot`[[3]] %>% layout(margin = list(b = 100, l = 70))
#`Non-communicable.Male.mort.plot`[[4]]
```

**Figure S8: Age-standardized trends in mortality related to non-communicable disease in black and white women, United States, 1969-2013**

```{r, fig.width = 9, fig.height = 7, echo = F}
`Non-communicable.Female.mort.plot`[[3]] %>% layout(margin = list(b = 100, l = 70))
#`Non-communicable.Male.mort.plot`[[4]]
```

**Figure S9: Age-standardized trends in injury-related mortality in black and white men, United States, 1969-2013**

```{r, fig.width = 9, fig.height = 7, echo = F}
Injuries.Male.mort.plot[[3]] %>% layout(margin = list(b = 100, l = 70))
#Injuries.Male.mort.plot[[4]]
```

**Figure S10: Age-standardized trends in injury-related mortality in black and white women, United States, 1969-2013**

```{r, fig.width = 9, fig.height = 7, echo = F}
Injuries.Female.mort.plot[[3]] %>% layout(margin = list(b = 100, l = 70)) 
#Injuries.Female.mort.plot[[4]]
```

**Figure S11: Age-standardized trends in mortality related to communicable disease in black and white men, United States, 1969-2013**

```{r print-3, fig.width = 9, fig.height = 7, echo = F}
Communicable.Male.mort.plot[[3]] %>% layout(margin = list(b = 100, l = 70))
#Communicable.Male.mort.plot[[4]]
```

**Figure S12: Age-standardized trends in mortality related to communicable disease in black and white women, United States, 1969-2013**

```{r print-4, fig.width = 9, fig.height = 7, echo = F}
Communicable.Female.mort.plot[[3]] %>% layout(margin = list(b = 100, l = 70))
#Communicable.Female.mort.plot[[4]]
```

**Figure S13: Age-standardized trends in mortality from all other causes in black and white men, United States, 1969-2013**

```{r, fig.width = 9, fig.height = 7, echo = F}
`All other causes.Male.mort.plot`[[3]] %>% layout(margin = list(b = 100, l = 70))
#`All other causes.Male.mort.plot`[[4]]
```

**Figure S14: Age-standardized trends in mortality from all other causes in black and white women, United States, 1969-2013**

```{r, fig.width = 9, fig.height = 7, echo = F}
`All other causes.Female.mort.plot`[[3]] %>% layout(margin = list(b = 100, l = 70)) 
#`All other causes.Female.mort.plot`[[4]]
```


