---
title: "Appendix: Trends in age-adjusted mortality rates for blacks and whites by cause and sex, 1969-2013, United States"
output: html_document
---

Corinne A Riddell, PhD

Department of Epidemiology, Biostatistics and Occupational Health, McGill University, Montreal, Canada.

Address correspondence to: Corinne Riddell, PhD, Department of Epidemiology, Biostatistics & Occupational Health, McGill University, 1020 Pine Avenue West, Room 36B, Montreal, QC H3A 1A2, Canada. Email: <corinne.riddell@mail.mcgill.ca>

```{r load_libraries, echo=FALSE, warning=F, message=F}
library(dplyr)
library(purrr)
library(ggplot2)
library(stringr)
library(reshape2)
library(grid)
library(gridExtra)
library(plotly)
library(forcats)

mortality.rates <- read.csv("/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Results/mortality_rates_combined.csv")
mortality.rates.diff <- read.csv("/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Results/mortality_rates_diff_combined.csv")

mortality.rates <- mortality.rates %>% mutate(state.reorder = reorder(state, as.numeric(Census_Division))) %>% rename(Race = race)
mortality.rates.diff <- mortality.rates.diff %>% mutate(state.reorder = reorder(state, as.numeric(Census_Division))) 
```

```{r refactor-for-us-map-plot, echo=F}

# Create unique blank strip labels for empty facets
bl = sapply(1:37, function(n) paste(rep(" ",n),collapse=""))

mortality.rates$state.reorder2 <- factor(mortality.rates$state,
                                        levels = c(bl[1:10], "Maine",
                                                   bl[11:19], "Vermont", "New Hampshire",
                                                   "Washington", "Idaho", "Montana", "North Dakota", "Minnesota", "Illinois", "Wisconsin", "Michigan", "New York", "Massachusetts", "Rhode Island",
                                                   "Oregon", "Nevada", "Wyoming", "South Dakota", "Iowa", "Indiana", "Ohio", "Pennsylvania", "New Jersey", "Connecticut", bl[20],
                                                   "California", "Utah", "Colorado", "Nebraska", "Missouri", "Kentucky", "West Virginia", "Virginia", "Maryland", "Delaware", bl[21],
                                                   bl[22], "Arizona", "New Mexico", "Kansas", "Arkansas", "Tennessee", "North Carolina", "South Carolina", "Washington DC", bl[23:24],
                                                   bl[25:27], "Oklahoma", "Louisiana", "Mississippi", "Alabama", "Georgia", bl[28:29],
                                                   bl[30:33], "Texas", bl[34:37], "Florida"))

mortality.rates.diff$state.reorder2 <- factor(mortality.rates.diff$state,
                                        levels = c(bl[1:10], "Maine",
                                                   bl[11:19], "Vermont", "New Hampshire",
                                                   "Washington", "Idaho", "Montana", "North Dakota", "Minnesota", "Illinois", "Wisconsin", "Michigan", "New York", "Massachusetts", "Rhode Island",
                                                   "Oregon", "Nevada", "Wyoming", "South Dakota", "Iowa", "Indiana", "Ohio", "Pennsylvania", "New Jersey", "Connecticut", bl[20],
                                                   "California", "Utah", "Colorado", "Nebraska", "Missouri", "Kentucky", "West Virginia", "Virginia", "Maryland", "Delaware", bl[21],
                                                   bl[22], "Arizona", "New Mexico", "Kansas", "Arkansas", "Tennessee", "North Carolina", "South Carolina", "Washington DC", bl[23:24],
                                                   bl[25:27], "Oklahoma", "Louisiana", "Mississippi", "Alabama", "Georgia", bl[28:29],
                                                   bl[30:33], "Texas", bl[34:37], "Florida"))
```

```{r plot-arrange-as-us-map, echo=F, fig.width=19.5, fig.height=14, results="asis", message = F}
# sex_i <- "Male"
# cod <- "Cardiovascular"

for(sex_i in c("Male", "Female")) {
  for(cod in levels(mortality.rates$COD)[c(3, 2, 4, 6, 5, 1)]) {
# for(sex_i in c("Male")) {
#   for(cod in levels(mortality.rates$COD)[1]) {
    cat("  \n### Age-adjusted mortality (per 100,000) in ", sex_i, " for ", cod, "  \n")

    data.sub <- subset(mortality.rates, sex == sex_i & COD == cod)
    lim.y <- max(data.sub$rate.per.100k_mean)
    map.plot1 <- ggplot(data.sub,
                        aes(y = rate.per.100k_mean, x = year)) +
      geom_vline(aes(xintercept = 1983), col = "#636363", lty = 3) +
      geom_vline(aes(xintercept = 1993), col = "#636363", lty = 3) +
      geom_line(aes(lty = Race, col = Race)) +
      geom_ribbon(aes(ymin = rate.per.100k_lcl, ymax = rate.per.100k_ucl, group = Race, fill = Race), col = NA, alpha = 0.5) +
      scale_color_manual(values = c("#2166ac", "#b2182b")) +
      scale_fill_manual(values = c("#67a9cf", "#ef8a62")) +
      scale_y_continuous(limits = c(0, lim.y)) + 
      facet_wrap( ~ state.reorder2, ncol = 11, drop = F, strip.position="bottom") +
      theme_classic(base_size = 20) +
      theme(axis.text.x = element_blank(),
            strip.background=element_blank(),
            axis.line=element_blank(),
            axis.ticks=element_blank()) +
      #theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      ylab("Age-standardized mortality rate (per 100,000)") +
      xlab("Year (1969-2013)")
    print(map.plot1)
    
    cat("  \n")
    
    cat("  \n### Black-white difference in age-adjusted mortality (per 100,000) in ", 
        sex_i, " for ", cod, "  \n")

    data.sub2 <- subset(mortality.rates.diff, sex == sex_i & COD == cod)
    lim.y2 <- max(data.sub2$rate.difference_mean)
    
    map.plot2 <- ggplot(data.sub2,
                        aes(y = rate.difference_mean, x = year)) +
      geom_vline(aes(xintercept = 1983), col = "#636363", lty = 3) +
      geom_vline(aes(xintercept = 1993), col = "#636363", lty = 3) +
      geom_ribbon(aes(ymin = rate.difference_LCL, ymax = rate.difference_UCL), fill = "grey", col = NA) +
      geom_line() +
      geom_hline(aes(yintercept = 0), col = "#636363") +
      scale_y_continuous(limits = c(0, lim.y2)) + 
      facet_wrap( ~ state.reorder2, ncol = 11, drop = F, strip.position="bottom") +
      theme_classic(base_size = 20) +
      theme(axis.text.x = element_blank(),
            strip.background=element_blank(),
            axis.line=element_blank(),
            axis.ticks=element_blank()) +
      #theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      ylab("Black-white difference (per 100,000)") +
      xlab("Year (1969-2013)")
    
    
    print(map.plot2)
    cat("  \n")
    cat("  \n")
  }
  cat("  \n")
}
```

```{r, echo=F, fig.width=11, fig.height=11, eval=F}

sex_i <- "Male"
cod <- "Injuries"

for(sex_i in c("Male", "Female")) {
  for(cod in levels(mortality.rates$COD)) {
    
# for(sex_i in c("Male")) {
#   for(cod in levels(mortality.rates$COD)[1]) {
    data.sub <- subset(mortality.rates, sex == sex_i & COD == cod)
    a <- ggplot(data.sub, 
                aes(y = rate.per.100k_mean, x = year)) + 
      geom_vline(aes(xintercept = 1983), col = "#636363", lty = 3) +
      geom_vline(aes(xintercept = 1993), col = "#636363", lty = 3) +
      geom_ribbon(aes(ymin = rate.per.100k_lcl, ymax = rate.per.100k_ucl, fill = Census_Division, group = Race), col = NA, alpha = 0.5) +
      geom_line(aes(col = Census_Division, lty = Race)) +
      # geom_line(aes(y = rate.per.100k_med, lty = Race)) +
      facet_wrap( ~ state.reorder, ncol = 5) +
      ylab("Age-standardized mortality rate (per 100,000)") +
      xlab("Year") + 
      ggtitle(paste0("Age-adjusted mortality (per 100,000) in ", sex_i, " for ", cod))# + theme_minimal()
    
    print(a)
    
    b <- ggplot(subset(mortality.rates.diff, sex == sex_i & COD == cod), 
                aes(y=rate.difference_mean, x = year)) + 
      geom_vline(aes(xintercept = 1983), col = "#636363", lty = 3) +
      geom_vline(aes(xintercept = 1993), col = "#636363", lty = 3) +
      geom_ribbon(aes(ymin = rate.difference_LCL, ymax = rate.difference_UCL, fill = Census_Division), col = NA, alpha = 0.5) +
      geom_hline(aes(yintercept = 0), col = "#636363") +
      #geom_line(aes(y = rate.difference_med)) +
      geom_line(aes(col = Census_Division)) +
      facet_wrap( ~ state.reorder, ncol = 5) +
      ylab("Black-white difference (per 100,000)") +
      xlab("Year") + 
      ggtitle(paste0("Black-white difference in age-adjusted mortality (per 100,000) in ", 
                     sex_i, " for ", cod))
    print(b)
    
  }
}
```

