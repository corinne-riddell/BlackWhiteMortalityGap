---
title: "Appendix: Trends in age-adjusted mortality rates for blacks and whites by cause and sex, 1969-2013, United States"
author: "Corinne Riddell"
date: "2/8/2017"
output: html_document
---

```{r load_libraries, echo=FALSE, warning=F, message=F}
library(dplyr)
library(purrr)
library(ggplot2)
library(stringr)
library(reshape2)
library(grid)
library(gridExtra)
library(plotly)
library(forcats)

mortality.rates <- read.csv("/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Results/mortality_rates_combined.csv")
mortality.rates.diff <- read.csv("/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Results/mortality_rates_diff_combined.csv")

mortality.rates <- mortality.rates %>% mutate(state.reorder = reorder(state, as.numeric(Census_Division)))
mortality.rates.diff <- mortality.rates.diff %>% mutate(state.reorder = reorder(state, as.numeric(Census_Division)))
```

```{r, echo=F}
# 
#  mortality.rates$state.reorder2 <- factor(mortality.rates$state, 
#                           levels = c("e1", "e2", "e3", "e4", "e5", "e6", "e7", "e8", "e9", "e10", "Maine",
#                                      "e11", "e12", "e13", "e14", "e15", "e16", "e17", "e18", "e19", "Vermont", "New Hampshire",
#                                      "Washington", "Idaho", "Montana", "North Dakota", "Minnesota", "Illinois", "Wisconsin", "Michigan", "New York", "Massachusettes", "Rhode Island",
#                                      "Oregon", "Nevada", "Wyoming", "South Dakota", "Iowa", "Indiana", "Ohio", "Pennsylvania", "New Jersey", "Connecticut", "e20",
#                                      "California", "Utah", "Colorado", "Nebraska", "Missouri", "Kentucky", "West Virginia", "Virginia", "Maryland", "Washington DC", "e21",
#                                      "e22", "Arizona", "New Mexico", "Kansas", "Arkansas", "Tennessee", "North Carolina", "South Carolina", "Delaware", "e23", "e24",
#                                      "e25", "e26", "e27", "Oklahoma", "Louisiana", "Mississippi", "Alabama", "Georgia", "e28", "e29",
#                                      "e30", "e31", "e32", "e33", "Texas", "e34", "e35", "e36", "e37", "Florida"))   
#     
#  data.sub <- subset(mortality.rates, sex == "Male" & COD == "Injuries")
#  test <- ggplot(data.sub, 
#                 aes(y = age.std.mortality.rate_med, x = year)) + 
#       geom_vline(aes(xintercept = 1983), col = "#636363", lty = 3) +
#       geom_vline(aes(xintercept = 1993), col = "#636363", lty = 3) +
#       geom_ribbon(aes(ymin = age.std.mortality.rate_LCL, ymax = age.std.mortality.rate_UCL, group = race, fill = Census_Division), col = NA, alpha = 0.5) +
#       geom_line(aes(col = Census_Division, lty = race)) +
#       facet_wrap( ~ state.reorder2, ncol = 11, drop = F) +
#       ylab("Age-standardized mortality rate (per 100,000)") +
#       xlab("Year") #+ 
#      # ggtitle(paste0("Age-adjusted mortality (per 100,000) in ", sex_i, " for ", cod))# + theme_minimal()
#  test
 
#  library(gridExtra)
# g <- ggplotGrob(test)
# ## remove empty panels
# g$grobs[names(g$grobs) %in% c("panel-1-1", "panel-1-2")] <- NULL
# ## remove them from the layout
# g$layout <- g$layout[!(g$layout$name %in% c("panel-1-1", "panel-1-2")),]
# ## move axis closer to panel
# #g$layout[g$layout$name == "axis_b-9", c("t", "b")] = c(9,9)
# 
# grid.newpage()
# grid.draw(g)
```

```{r, echo=F, fig.width=11, fig.height=11}

sex_i <- "Male"
cod <- "Injuries"

for(sex_i in c("Male", "Female")) {
  for(cod in levels(mortality.rates$COD)) {
    data.sub <- subset(mortality.rates, sex == sex_i & COD == cod)
    a <- ggplot(data.sub, 
                aes(y = rate.per.100k_med, x = year)) + 
      geom_vline(aes(xintercept = 1983), col = "#636363", lty = 3) +
      geom_vline(aes(xintercept = 1993), col = "#636363", lty = 3) +
      geom_ribbon(aes(ymin = rate.per.100k_lcl, ymax = rate.per.100k_ucl, fill = Census_Division, group = race), col = NA, alpha = 0.5) +
      geom_line(aes(col = Census_Division, lty = race)) +
      # geom_line(aes(y = rate.per.100k_mean, lty = race)) +
      facet_wrap( ~ state.reorder, ncol = 5) +
      ylab("Age-standardized mortality rate (per 100,000)") +
      xlab("Year") + 
      ggtitle(paste0("Age-adjusted mortality (per 100,000) in ", sex_i, " for ", cod))# + theme_minimal()
    
    print(a)
    
    b <- ggplot(subset(mortality.rates.diff, sex == sex_i & COD == cod), 
                aes(y=rate.difference_med, x = year)) + 
      geom_vline(aes(xintercept = 1983), col = "#636363", lty = 3) +
      geom_vline(aes(xintercept = 1993), col = "#636363", lty = 3) +
      geom_ribbon(aes(ymin = rate.difference_LCL, ymax = rate.difference_UCL, fill = Census_Division), col = NA, alpha = 0.5) +
      geom_hline(aes(yintercept = 0), col = "#636363") +
      #geom_line(aes(y = rate.difference_mean)) +
      geom_line(aes(col = Census_Division)) +
      facet_wrap( ~ state.reorder, ncol = 5) +
      ylab("Black-white difference (per 100,000)") +
      xlab("Year") + 
      ggtitle(paste0("Black-white difference in age-adjusted mortality (per 100,000) in ", 
                     sex_i, " for ", cod))
    print(b)
    
  }
}
```

