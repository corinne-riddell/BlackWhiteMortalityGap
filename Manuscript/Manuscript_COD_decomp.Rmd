---
title: Exploring how changes in age at death and cause of death have narrowed the
  black-white life expectancy gap over forty-five years in the United States.
output:
  html_document: default
  word_document: default
always_allow_html: yes
---

##Riddell CA, Morrison KT, Kaufman JS, Harper S 

###Abstract

###Introduction
The life expectancy of a population is a barometer for overall health. In 2014, life expectancy in the United States was 78.7 years, but hidden within this figure are differences by race. Non-Hispanic whites lived 3.6 years longer than Non-Hispanic blacks [ref: http://www.cdc.gov/nchs/data/nvsr/nvsr65/nvsr65_04.pdf]. While both black and white Americans have experienced increases in life expectancy since X, the difference between their life expectancies has varied. During the 1980s, the life expectancy gap widened and then narrowed in the 1990s due to relative mortality improvements among blacks in deaths due to homicide, HIV, unintentional injuries, and, among females, heart disease [Harper 2007]. The gap continued to narrow during the 2000s, but states differed in the magnitude of improvement that was made. For example, the life expectancy gap in New York decreased from 8.0 years to 2.4 years between 1990 and 2009, but in California the decrease was much more modest -- from 6.7 years to 5.6 years [Harper 2014]. This study seeks to better understand these state-level differences, by examining how changes in the cause of death [*and age at death(?)*] over time have worked to narrow or exacerbate the life expectancy gap within each state between 1969 and 2013. Thus, common reasons for the decreasing life expectancy gap can be identified, and anomalous states can be examined.

###Methods

**The data**

We used software maintained by the National Cancer Institute's Surveillance, Epidemiology, and End Results Program (SEER*Stat) to extract data on the number of deaths and the population size in all 50 US states and the District of Columbia between 1969 and 2013. The mortality data was originally collected by the National Center for Health Statistics (NCHS) from death certificates and stored by the National Vital Statistics System. The population data was derived by the NCHS using intercensal bridged-race population estimates. This study using data on the number of deaths and the population size according to race (black or white), sex (male or female), age group (<1 year old, 1-4 years old, followed by 5-year age groupings, with a final grouping of 85 or more years of age), year (1969 -- 2013), and cause of death. Cause of death was originally recorded using the International Classification of Diseases (ICD) codes versions 8 (1969-1979), 9 (1979-1998), and 10 (1999-2013). These codes were aggregated into six broad causes of death for this analysis: Cancers, Cardiovascular disease, Communicable disease, Injuries, Non-communicable disease, and All other causes. This recoding is illustrated in eTable 1 in the eAppendix of the Supplement. When the number of deaths for a population is between 1 and 9, this data is suppressed by the software and produces a missing death count for that strata. However, death counts of exactly 0 or greater than 9 are known precisely. 

For the analysis we excluded 11 states with the smallest black populations: Alaska, Hawaii, Idaho, Maine, Montana, New Hampshire, North Dakota, South Dakota, Utah, Vermont, and Wyoming. These states contained less than 0.4% of the blacks in the United States in 2010 [ref]. We did not consider Hispanic origin to identify race according to Hispanic ethnicity, since the quality of the coding of ethnicity varied by state over the time period included [https://www.cdc.gov/nchs/data/series/sr_02/sr02_148.pdf].   

**Statistical Methods**

The data produced two statistical issues that were addressed by our statistical methods. First, our methodology needed to impute the suppressed death counts (for counts between 1 and 9). Second, several states had small blacks populations which produced even smaller population sizes in each sex-age category. In these cases, the estimation of the sex-age mortality rates is imprecise, and produces abrupt changes in the estimation of mortality rates over time that are unrealistic. To better estimate the underlying age-specific mortality rates, a method that produces smoother age-specific mortality trends was required.

To address these challenges, we used a Bayesian autoregressive model to smooth the data over time, and incorporated a truncated Poisson model to impute the suppressed death counts. Specifically, we used Poisson regression to model the number of deaths in each state-age-sex-race-year category as a function of the at-risk population. The mortality rates over time within each state-age-sex-race category are modelled autoregressively, where the log mortality rate in the current year was modelled as a normal variable centred at the log mortality rate estimated from the previous year. Truncated Poisson regression was used to impute the supressed death counts, by specifying that the supressed counts were sampled from a Poisson distribution and were constrained to be between 1 and the maximum of 9 and the at-risk population size (which may be smaller than 9). These models were run separately for every combination of state, race, and sex, and produced death counts that had been smoothed over time for every cause of death within each age group.

To calculate life expectancy at birth, the smoothed death counts were aggregated to estimate the total deaths in each age group and standard life table methods were applied [ref]. Life expectancy at birth (in years) was calculated for blacks and whites in each state and year according to sex. The difference in life expectancy between blacks and whites was calculated by subtracting the black life expectancy from the white life expectancy in every state, year, and sex.

To decompose the difference in life expectancy between blacks and whites, we performed a decomposition analysis using the Arriaga method [ref]. First, the decomposition analysis partitions the difference in life expectancy by age group, which can be interpreted as the amount of the gap (in years) that can be attributed to higher age-specific mortality rates in blacks. For example, a decomposition of a gap of five years may find that two of the five years (40% of the gap) is attributable to a higher mortality rate in blacks in the youngest age group (< 1 years old) compared with the youngest whites. This age-specific decomposition can be further partitioned according to cause of death, producing the number of years of the gap that is attributable to every age- and cause-of-death combination. For example, a decomposition of a gap of 8 years may find that 1.3 years of this gap is attributable to more injury-related deaths in blacks aged 25-29 years old. We summed these age- and cause-of-death partitions over all ages to calculate the marginal contribution of each cause-of-death to the difference.

In order to understand whether states fared similarly over time, we divided the time frame into three eras which roughly encapsulate an initial period of increases in life expectancy for both races and sexes (1969-1983), an intermediate period of decreases and stagnating life expectancy for blacks but not for whites (1983-1993) and a final period of increasing life expectancy for both races (1993-2013). While these eras represent different lengths of time, they best capture three distinct periods of changes to the difference in life expectancy: an intial narrowing of the gap, followed by a widening of the gap that diminished previous progress, and the most recent twenty years of sustained narrowing (eAppendix Figures 1 and 2).

For each era, we calculated the degree that the life expectancy gap has narrowed or widened over the era and decomposed this *change* to the *difference* in the life expectnacy between blacks and whites according to cause of death. To do so, we simply subtracted the contribution (in years) that each cause of death category had made to the difference in life expectancy at the beginning of the era from that made at the beginning of the era. An example of the calculation is found in the eAppendix.

*To re-write*: To calculate 95% credible intervals, we sampled 1000 times from the posterior distribution to create 1000 samples for each strata. We performed all calculated on each sample and took the median of the estimates as the estimate and the 2.5 and 97.5th qunatiles as the lower and upper bound for the 95% CI. Anything about thinning?

All data analyses were performed using R version 3.3.1. The bayesian smoothing was performed using `JAGS` (version X.X), and the life expectancy and decomposition analysis were performed using user-written functions found in the Supplement. 

###Results

```{r initialize, echo=FALSE, warning=F, message=F}
library(shiny)
library(plotly)
library(viridis)
library(scales)
library(shinythemes)
library(dplyr)
library(purrr)
library(stringr)
source("/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Code/life_expectancy_functions.R")
```

```{r read_data, echo=F}
age_cod_results <- read.csv("/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Results/age_cod_results.csv")
age_decomp_results <- read.csv("/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Results/age_decomp_results.csv")
cod_decomp_results <- read.csv("/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Results/cod_decomp_results.csv")
BlackWhite_results <- read.csv("/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Results/BlackWhite_results.csv")

COD.levels <- c("Cardiovascular", "Cancers", "Communicable", 
                "Non-communicable", "Injuries", "All other causes")

cod_decomp_results$COD <- factor(cod_decomp_results$COD, COD.levels)
age_cod_results$COD <- factor(age_cod_results$COD, levels(age_cod_results$COD)[c(3, 2, 4, 5, 6, 1)])

age_decomp_results$age <- factor(age_decomp_results$age, levels = levels(age_decomp_results$age)[c(1, 2, 11, 3:10, 12:19)])
age_cod_results$age <- factor(age_cod_results$age, levels = levels(age_cod_results$age)[c(1, 2, 11, 3:10, 12:19)])                                                             
```

```{r prep_era_figure_males, echo = F}
year1 <- 1969
year2 <- 1983
year3 <- 1993
year4 <- 2013

bw_dat <- BlackWhite_results %>% 
  filter(year %in% c(year1, year2, year3, year4), is.na(LE_wbgap) == F) %>%
  select(state, year, LE_wbgap, sex) %>%
  arrange(year)

bw_dat <- tidyr::spread(bw_dat, year, LE_wbgap) 
names(bw_dat)[3:6] <- c("first.gap","second.gap", "third.gap", "fourth.gap")  
bw_dat.males <- bw_dat %>% filter(sex == "Male") %>%
  mutate(era1.diff = first.gap - second.gap,
         era2.diff = second.gap - third.gap,
         era3.diff = third.gap - fourth.gap,
         state.gdiff.order.1 = reorder(state, first.gap),
         state.gdiff.num.1 = as.numeric(state.gdiff.order.1),
         state.gdiff.order.2 = reorder(state, second.gap),
         state.gdiff.num.2 = as.numeric(state.gdiff.order.2),
         state.gdiff.order.3 = reorder(state, third.gap),
         state.gdiff.num.3 = as.numeric(state.gdiff.order.3)
  )

bw_dat.females <- bw_dat %>% filter(sex == "Female") %>%
  mutate(era1.diff = first.gap - second.gap,
         era2.diff = second.gap - third.gap,
         era3.diff = third.gap - fourth.gap,
         state.gdiff.order.1 = reorder(state, first.gap),
         state.gdiff.num.1 = as.numeric(state.gdiff.order.1),
         state.gdiff.order.2 = reorder(state, second.gap),
         state.gdiff.num.2 = as.numeric(state.gdiff.order.2),
         state.gdiff.order.3 = reorder(state, third.gap),
         state.gdiff.num.3 = as.numeric(state.gdiff.order.3)
  )

cod.df <- data.frame(state = factor(), sex = factor(), era = character(), 
                     COD = factor(), Contribution.to.change = numeric(), 
                     Contrib.to.change.prop = numeric(), narrowed_gap = logical())

age.df <- data.frame(state = factor(), sex = factor(), era = character(), 
                     age_minbin = numeric(), Contribution.to.change = numeric(), 
                     Contrib.to.change.prop = numeric(), narrowed_gap = logical())

years <- c(1969, 1983, 1993, 2013)

for (state.i in levels(BlackWhite_results$state)) {
  for (sex.i in c("Male", "Female")) {
    for (year.i in 1:3) {
      
      table1 <- cod_decomp_results %>% filter(state == state.i & sex == sex.i & year == years[year.i]) %>% arrange(COD)
      table2 <- cod_decomp_results %>% filter(state == state.i & sex == sex.i & year == years[year.i + 1]) %>% arrange(COD)
      
      table3 <- age_decomp_results %>% filter(state == state.i & sex == sex.i & year == years[year.i]) %>% arrange(age_minbin)
      table4 <- age_decomp_results %>% filter(state == state.i & sex == sex.i & year == years[year.i + 1]) %>% arrange(age_minbin)
      
      temp1 <- data.frame(state = state.i, sex = sex.i, era = paste0(years[year.i], "-",  years[year.i + 1]),
                          contribution.to.gap.change(type.of.decomp = "COD", 
                                                     decomp.table1 = table1, 
                                                     decomp.table2 = table2, 
                                                     type.of.data = "results"))
      
      temp2 <- data.frame(state = state.i, sex = sex.i, era = paste0(years[year.i], "-",  years[year.i + 1]),
                          contribution.to.gap.change(type.of.decomp = "Age", 
                                                     decomp.table1 = table3, 
                                                     decomp.table2 = table4,
                                                     type.of.data = "results"))
      
      cod.df <- rbind(cod.df, temp1)
      age.df <- rbind(age.df, temp2)
    }
  }
}

```

```{r more_figure_prep, echo = F}

cod.df <- make_pretty_decomp_plot(decomp.table = cod.df, strat.var.1 = "state", 
                        strat.var.2 = "sex", strat.var.3 = "era", 
                        sign.var = "narrowed_gap",
                        decomp.var = "Contribution.to.change",
                        decomp.var.prop = "Contrib.to.change.prop", 
                        partition.bar.var = "COD", type.of.data = "results")

age.df <- make_pretty_decomp_plot(decomp.table = age.df, strat.var.1 = "state", 
                        strat.var.2 = "sex", strat.var.3 = "era", 
                        sign.var = "narrowed_gap",
                        decomp.var = "Contribution.to.change",
                        decomp.var.prop = "Contrib.to.change.prop", 
                        partition.bar.var = "Ages", type.of.data = "results")

cod.df <- merge(cod.df, BlackWhite_results[BlackWhite_results$year == 1969 & BlackWhite_results$sex == "Male", 
                                           c("state", "Census_Region", "Census_Division", "stabbrs")], by = c("state"))
```

*Changes to the difference in life expectancy in US males, 1969-1983*

**Figure 1a** displays each state's male life expectancy gap in 1969 (vertical dashed line) vs. their gap in 1983 (solid dashed line), with the change in the gap being represented by the number of years between these lines. This gap is decomposed by cause of death, where causes to the left of the dashed line contributed to narrowing the gap and causes to the right contributed to widening the gap. The length of these coloured bars represent the number of years attributable to the cause. 

For example, in the **Figure 1a**, New York's gap changed from 8.8 years in 1969 to 6.3 in 1983. Causes to the left of the dashed line -- All other causes (pink), injuries (blue), non-communicable diseases (teal), and communicable diseases (green) -- each contributed to narrowing the gap, while cardiovascular disease (red) and cancer (yellow) contributed to widening the gap. Since the contribution in years of the leftward causes is larger than the contribution of the rightward causes, the net change is a smaller life expectancy gap in 1983, where all other causes (the longest bar) made the largest contribution.

```{r, echo = F}
sum1 <- BlackWhite_results %>% filter(year == 1969 & sex == "Male") %>% 
  arrange(LE_wbgap) %>% 
  select(state, LE_wbgap_lcl, LE_wbgap, LE_wbgap_ucl)

diff <- bw_dat.males %>% arrange(era1.diff)

for(i in 1:5) {
  j <- i-1
  
  max.value <- max(cod.df$Contribution.to.change[cod.df$state == diff[dim(diff)[1]-j, ]$state & 
                                            cod.df$era == "1969-1983" &
                                            cod.df$sex == "Male" ])
  
  max.cause <- cod.df$COD[cod.df$state == diff[dim(diff)[1]-j, ]$state &
                    cod.df$sex == "Male" &
                    cod.df$era == "1969-1983" & 
                    cod.df$Contribution.to.change == max.value]
 
  min.value <- min(cod.df$Contribution.to.change[cod.df$state == diff[i, ]$state & 
                                            cod.df$era == "1969-1983" &
                                            cod.df$sex == "Male" ])
  
  min.cause <- cod.df$COD[cod.df$state == diff[i, ]$state &
                    cod.df$sex == "Male" &
                    cod.df$era == "1969-1983" & 
                    cod.df$Contribution.to.change == min.value]
  
  assign(paste0("max", i), max.value)
  assign(paste0("max.cause", i), max.cause)
  assign(paste0("min", i), min.value)
  assign(paste0("min.cause", i), min.cause)
}
```

In 1969, the life expectancy gap ranged from `r round(sum1[1, ]$LE_wbgap, 1)` [95% CI: `r round(sum1[1, ]$LE_wbgap_lcl, 1)`, `r round(sum1[1, ]$LE_wbgap_ucl, 1)`] in `r sum1[1, ]$state ` to `r round(sum1[dim(sum1)[1], ]$LE_wbgap, 1)` [95% CI: `r round(sum1[dim(sum1)[1], ]$LE_wbgap_lcl, 1)`, `r round(sum1[dim(sum1)[1], ]$LE_wbgap_ucl, 1)`] years in `r sum1[dim(sum1)[1], ]$state `. Injuries was the largest contributor towards narrowing the gap during this time period, as both races underwent decreased rates of injury-related mortality, but blacks experienced larger decreases to their rates, especially in states with relatively higher rates in 1969 (**eAppendix B: Age-adjusted mortality by causes of death**). Minnesota and Nebraska are exceptions, where both states had relatively low rates of injuries among blacks in 1969 and smaller gaps. All other causes also contributed to narrower gaps in most states, but generally made a smaller contribution than injuries. In New York, all other causes made a large contribution to narrowing the gap, where much of this decrease was likely due to decreased infant mortality among blacks (**eFigure 3**). Communicable diseases modestly contributed to narrowing the gap, except in Arizona and Minnesota. Generally, cardivascular disease contributed towards increasing the gap, and reflects slower declines for blacks in cardiovascular mortality than for whites. Cancer generally contributed towards increasing the gap, and largely reflects increased cancer-related mortality for both races, with blacks undergoing steeper changes. In most states, non-comunicable diseases contributed a small amount towards increasing the gap, although it decreased the gap among four states, most notably in New York.

For `r dim(bw_dat.males[bw_dat.males$era1.diff > 0,])[1]` states, the gap decreased between 1969 and 1983, with the largest decreases in `r diff[dim(diff)[1], ]$state` (decrease in the gap of `r round(diff[dim(diff)[1], ]$era1.diff, 1)`, `r round(max1,1)` years, of which is due to `r max.cause1`), `r diff[dim(diff)[1]-1, ]$state` (change of `r round(diff[dim(diff)[1]-1, ]$era1.diff, 1)`, `r round(max2,1)` due to `r max.cause2`), `r diff[dim(diff)[1]-2, ]$state` (change of `r round(diff[dim(diff)[1]-2, ]$era1.diff, 1)`, `r round(max3,1)` due to `r max.cause3`), `r diff[dim(diff)[1]-3, ]$state` (change of `r round(diff[dim(diff)[1]-3, ]$era1.diff, 1)`, `r round(max4,1)` due to `r max.cause4`), and `r diff[dim(diff)[1]-4, ]$state` (change of `r round(diff[dim(diff)[1]-4, ]$era1.diff, 1)`, `r round(max5,1)` due to `r max.cause5`). 

The gap increased for `r dim(bw_dat.males[bw_dat.males$era1.diff < 0,])[1]` states. Most notably in `r diff$state[1]` (increase in gap of `r round(abs(diff$era1.diff[1]), 1)`, `r abs(round(min1,1))` due to `r min.cause1`), `r diff$state[2]` (increase in gap of `r round(abs(diff$era1.diff[2]), 1)`, `r abs(round(min2,1))` due to `r min.cause2`), `r diff$state[3]` (increase in gap of `r round(abs(diff$era1.diff[3]), 1)`, `r abs(round(min3,1))` due to `r min.cause3`), `r diff$state[4]` (increase in gap of `r round(abs(diff$era1.diff[4]), 1)`, `r abs(round(min4,1))` due to `r min.cause4`). For these states, injuries do not contribute as much to narrowing the gap as in other states (and in Minnesota, injuries widens the gap), so these gap increases appear to be due to a combination of changes to cardiovascular-related mortality making blacks relatively worse off and less changes to injuries than experienced by other states.

**Figure 1a: Decomposition of the change in the male black-white life expectancy gap by cause of death between 1969 and 1983 by US state**

```{r figure1, fig.align = "center", echo=F, fig.height=9, fig.width=7}

cod.df.males <- merge(subset(cod.df, sex == "Male"), bw_dat.males, by = c("state"))
cod.df.males <- cod.df.males %>% mutate(new.start.1 = -start + first.gap, new.finish.1 = -finish + first.gap,
                                        new.start.2 = -start + second.gap, new.finish.2 = -finish + second.gap,
                                        new.start.3 = -start + third.gap, new.finish.3 = -finish + third.gap)

y.labels <- levels(factor(cod.df.males$state.gdiff.order.1))
y.num.breaks <- length(levels(factor(cod.df.males$state.gdiff.order.1)))

males.era1 <- ggplotly(
  ggplot(subset(cod.df.males, era == "1969-1983"), aes(y = state.gdiff.num.1, x = new.start.1)) +
    geom_rect(aes(xmin = new.start.1, ymin = state.gdiff.num.1 - 0.45, 
                  ymax = state.gdiff.num.1 + 0.45, 
                  xmax = new.finish.1, fill = COD), 
              color = "white") +
#    facet_grid(.~ Census_Region) +
    geom_segment(data = subset(cod.df.males, COD == "Cancers" & era == "1969-1983"), aes(x = second.gap, xend = second.gap, y = state.gdiff.num.1 - 0.5, yend = state.gdiff.num.1 + 0.5)) + 
        geom_segment(data = subset(cod.df.males, COD == "Cancers" & era == "1969-1983"), aes(x = first.gap, xend = first.gap, y = state.gdiff.num.1 - 0.5, yend = state.gdiff.num.1 + 0.5), lty = 3) + 
   # geom_segment(data = bw_dat.males,
  #               aes(x = second.gap, xend= second.gap, y = state.gdiff.num.1 - 0.5, yend = state.gdiff.num.1 + 0.5)) +
  #  geom_segment(data = bw_dat.males,
  #               aes(x = first.gap, xend= first.gap, y = state.gdiff.num.1 - 0.5, yend = state.gdiff.num.1 + 0.5), lty = 3) +
    theme_minimal() + scale_y_continuous(breaks = 1:y.num.breaks, labels = y.labels)) %>%
  layout(xaxis = list(title = "Life expectancy gap (years): 1969-1983"), yaxis = list(title = NA, autorange = "reversed"))

males.era1
```

```{r, echo =F}
sum2 <- BlackWhite_results %>% filter(year == 1983 & sex == "Male") %>% 
  arrange(LE_wbgap) %>% 
  select(state, LE_wbgap_lcl, LE_wbgap, LE_wbgap_ucl)

  min.value.DC <- min(cod.df$Contribution.to.change[cod.df$state == "Washington DC" & 
                                            cod.df$era == "1983-1993" &
                                            cod.df$sex == "Male" ])
  
  min.cause.DC <- cod.df$COD[cod.df$state == "Washington DC" &
                    cod.df$sex == "Male" &
                    cod.df$era == "1983-1993" & 
                    cod.df$Contribution.to.change == min.value.DC]
```

**Figure 1b** displays each state's male life expectancy gap in 1983 (vertical dashed line) vs. their gap in 1993 (solid dashed line).[Be careful with the interpretation: the x-axis is much wider for this plot because of DC.]

During the second time period, from 1983 to 1993, the life expectancy gap for males in `r dim(bw_dat.males[bw_dat.males$era2.diff < 0, ])[1]` of the analysed `r dim(bw_dat.males)[1]` widened. For states such as New York, Maryland, New Jersey, and Connecticut, the biggest driver of the widening gap was communicable disease, reflecting the heightened risk of dying from HIV/AIDS in black males during the height of the AIDS epidemic. While both blacks and whites experienced a dramatic increase in mortality related to communicable diseases, blacks' rates were even higher. Injuries also contributed to the gap widening, most notably in Wisconsin, Maryland, and Louisiana. For many states, injury-related mortality increased for blacks but not for whites during this time period. Compared to the previous period, these two causes of death led to widwer rather than narrowed gaps. Cancer and cardiovascular disease contributed towards wider gaps, although the magnitude of the contribution of cardiovascular disease is quite hetergenous by state, with Mississippi, Minnesota, and Pennsylvania seeing the largest absolute contributions. All other causes contributed to a narrower gap, especially in New York, Pennsylvania, Connecticut, Mississippi, and Florida [note: This wasn't related to infant mortality improvements among blacks in NY, PA, but partially related to IMR improvements in CT, MS, and FL]. Most notably, the Disrict of Columbia had the highest gap to begin and underwent the largest increase to their gap, which increased from 10.5 years to 15.9 years over this 10-year period, reflecting an increase of `r abs(round(bw_dat.males$era2.diff[bw_dat.males$sex == "Male" & bw_dat.males$state == "Washington DC"], 1))` years, of which `r round(min.value.DC, 1)` was due to `r min.cause.DC`.

**Figure 1b: Decomposition of the change in the male black-white life expectancy gap by cause of death between 1983 and 1993 by US state**

```{r figure1b, echo = F, fig.height=9, fig.width=11}
# - The gap in 1983 ranges from `r round(sum2[1, ]$LE_wbgap, 1)` [95% CI: `r round(sum2[1, ]$LE_wbgap_lcl, 1)`, `r round(sum2[1, ]$LE_wbgap_ucl, 1)`] in `r sum2[1, ]$state ` to `r round(sum2[dim(sum2)[1], ]$LE_wbgap, 1)` [95% CI: `r round(sum2[dim(sum2)[1], ]$LE_wbgap_lcl, 1)`, `r round(sum2[dim(sum2)[1], ]$LE_wbgap_ucl, 1)`] years in `r sum2[dim(sum2)[1], ]$state `.

y.labels.2 <- levels(factor(cod.df.males$state.gdiff.order.2))
y.num.breaks.2 <- length(levels(factor(cod.df.males$state.gdiff.order.2)))

males.era2 <- ggplotly(
  ggplot(subset(cod.df.males, era == "1983-1993"), aes(y = state.gdiff.num.2, x = new.start.2)) +
    geom_rect(aes(xmin = new.start.2, ymin = state.gdiff.num.2 - 0.45, 
                  ymax = state.gdiff.num.2 + 0.45, 
                  xmax = new.finish.2, fill = COD), 
              color = "white") +
    geom_segment(data = bw_dat.males, 
                 aes(x = third.gap, xend= third.gap, y = state.gdiff.num.2 - 0.5, yend = state.gdiff.num.2 + 0.5)) +
    geom_segment(data = bw_dat.males, 
                 aes(x = second.gap, xend= second.gap, y = state.gdiff.num.2 - 0.5, yend = state.gdiff.num.2 + 0.5), lty = 3) +
    theme_minimal() + scale_y_continuous(breaks = 1:y.num.breaks.2, labels = y.labels.2)) %>% 
  layout(xaxis = list(title = "Life expectancy gap (years): 1969-1983"), yaxis = list(title = NA, autorange = "reversed"))

males.era2 
```

```{r, echo =F}
sum3 <- BlackWhite_results %>% filter(year == 1993 & sex == "Male") %>% 
  arrange(LE_wbgap) %>% 
  select(state, LE_wbgap_lcl, LE_wbgap, LE_wbgap_ucl)

sum4 <- BlackWhite_results %>% filter(year == 2013 & sex == "Male") %>% 
  arrange(LE_wbgap) %>% 
  select(state, LE_wbgap_lcl, LE_wbgap, LE_wbgap_ucl)
```

- The gap in 1993 ranges from `r round(sum3[1, ]$LE_wbgap, 1)` [95% CI: `r round(sum3[1, ]$LE_wbgap_lcl, 1)`, `r round(sum3[1, ]$LE_wbgap_ucl, 1)`] in `r sum3[1, ]$state ` to `r round(sum3[dim(sum3)[1], ]$LE_wbgap, 1)` [95% CI: `r round(sum3[dim(sum3)[1], ]$LE_wbgap_lcl, 1)`, `r round(sum3[dim(sum3)[1], ]$LE_wbgap_ucl, 1)`] years in `r sum3[dim(sum3)[1], ]$state ` (or `r round(sum3[dim(sum3)[1]-1, ]$LE_wbgap, 1)` when DC is excluded).

- By 2013, it ranges from `r round(sum4[1, ]$LE_wbgap, 1)` [95% CI: `r round(sum4[1, ]$LE_wbgap_lcl, 1)`, `r round(sum4[1, ]$LE_wbgap_ucl, 1)`] in `r sum4[1, ]$state ` to `r round(sum4[dim(sum4)[1], ]$LE_wbgap, 1)` [95% CI: `r round(sum4[dim(sum4)[1], ]$LE_wbgap_lcl, 1)`, `r round(sum4[dim(sum4)[1], ]$LE_wbgap_ucl, 1)`] years in `r sum4[dim(sum4)[1], ]$state ` (or `r round(sum4[dim(sum4)[1]-1, ]$LE_wbgap, 1)` when DC is excluded).

- After 1993, the gap narrowed for all states shown, and in most cases all of the causes contributed to the narrowing of the gap. Notice again that in Wisconsin and DC, changes to CVD mortality counteract the gap narrowing, while in Arizona changes to communicable disease counteract the narrowing.

**Figure 1c: Decomposition of the change in the male black-white life expectancy gap by cause of death between 1993 and 2013 by US state**

```{r figure1c, echo = F}
y.labels.3 <- levels(factor(cod.df.males$state.gdiff.order.3))
y.num.breaks.3 <- length(levels(factor(cod.df.males$state.gdiff.order.3)))

males.era3 <- ggplotly(
  ggplot(subset(cod.df.males, era == "1993-2013"), aes(y = state.gdiff.num.3, x = new.start.3)) +
    geom_rect(aes(xmin = new.start.3, ymin = state.gdiff.num.3 - 0.45, 
                  ymax = state.gdiff.num.3 + 0.45, 
                  xmax = new.finish.3, fill = COD), 
              color = "white") +
    geom_segment(data = bw_dat.males, 
                 aes(x = fourth.gap, xend= fourth.gap, y = state.gdiff.num.3 - 0.5, yend = state.gdiff.num.3 + 0.5)) +
    geom_segment(data = bw_dat.males, 
                 aes(x = third.gap, xend= third.gap, y = state.gdiff.num.3 - 0.5, yend = state.gdiff.num.3 + 0.5), lty = 3) +
    theme_minimal() + scale_y_continuous(breaks = 1:y.num.breaks.3, labels = y.labels.3)) %>% 
  layout(xaxis = list(title = "Life expectancy gap (years): 1993-2013"), yaxis = list(title = NA, autorange = "reversed"))

males.era3
```

```{r, fig.align="center", fig.height=5, fig.width=9, echo=F, eval = F}
subplot(males.era1, males.era2, males.era3, shareY = T)
```
** **
** **

```{r, echo =F}
sum5 <- BlackWhite_results %>% filter(year == 1969 & sex == "Female") %>% 
  arrange(LE_wbgap) %>% 
  select(state, LE_wbgap_lcl, LE_wbgap, LE_wbgap_ucl)
```

*Changes to the difference in life expectancy in US females*

Quick summary

- Most states saw decreasing gaps in first era. 

- However, increases were found in Arizona, Oregon, Minnesota, Washington, and Wisconsin, largely due to cardiovascular disease. As you can see, in some states CVD contributed to excacerbating the gap while in most others it makes a large contribution to narrowing the gap.

- Otherwise, most of the other causes contributed to the gap narrowing, although cancer was associated with narrowing in some states (MS, NM, Oregon, for example) and increases in others (Pennsylvania, Ohio, Missouri, Kentucky).

- The biggest contributor to the narrowing gap being CVD (in most states, although heterogeniety) and all other causes. 

- During the second era, the gap stayed approx. the same or widened across most states. Delaware, Kentucky, Oregon, Rhode Island, West Virginia, Alabama, were notable exceptions were the gap narrowed -- didn't see effect of communicable disease like other states on the gap increasing (NY, FL, DC, MD, CT, hardest hit). 

- In women, changes in injury related deaths doesn't play a big role (except DC).

- CVD differential by state. Contributes to widening the gap in CA, Mississippi, and DC, for example, and narrowing it in Kansas, Delaware, and Kentucky.

- All other causes narrows across states (except DC, Indiana). Cancer increases the gap by a bit (except Rhode Island, Oregon, and Minnesota).

- During the third era, in-line with males, the life expectancy gap decreased during the last 20 year period (except DC, Wisconsin), and generally speaking all of the causes contributed to the gap narrowing over time. The biggest contributors were CVD and all other causes.

- In a few states, cancer contributed to widening the gap (NM, Oregon, Arizona, DC, Wisconsin).

**Figure 2a: Decomposition of the change in the female black-white life expectancy gap by cause of death between 1969 and 1983 by US state**

```{r figure2a, fig.align = "center", echo=F}

cod.df.females <- merge(subset(cod.df, sex == "Female"), bw_dat.females, by = c("state"))
cod.df.females <- cod.df.females %>% mutate(new.start.1 = -start + first.gap, new.finish.1 = -finish + first.gap,
                                        new.start.2 = -start + second.gap, new.finish.2 = -finish + second.gap,
                                        new.start.3 = -start + third.gap, new.finish.3 = -finish + third.gap)

y.labels <- levels(factor(cod.df.females$state.gdiff.order.1))
y.num.breaks <- length(levels(factor(cod.df.females$state.gdiff.order.1)))

females.era1 <- ggplotly(
  ggplot(subset(cod.df.females, era == "1969-1983"), aes(y = state.gdiff.num.1, x = new.start.1)) +
    geom_rect(aes(xmin = new.start.1, ymin = state.gdiff.num.1 - 0.45, 
                  ymax = state.gdiff.num.1 + 0.45, 
                  xmax = new.finish.1, fill = COD), 
              color = "white") +
    geom_segment(data = bw_dat.females,
                 aes(x = second.gap, xend= second.gap, y = state.gdiff.num.1 - 0.5, yend = state.gdiff.num.1 + 0.5)) +
    geom_segment(data = bw_dat.females,
                 aes(x = first.gap, xend= first.gap, y = state.gdiff.num.1 - 0.5, yend = state.gdiff.num.1 + 0.5), lty = 3) +
    theme_minimal() + scale_y_continuous(breaks = 1:y.num.breaks, labels = y.labels)) %>%
  layout(xaxis = list(title = "Life expectancy gap (years): 1969-1983"), yaxis = list(title = NA, autorange = "reversed"))

females.era1
```

**Figure 2b: Decomposition of the change in the female black-white life expectancy gap by cause of death between 1983 and 1993 by US state**

```{r figure2b, fig.align = "center", echo=F}
y.labels.2 <- levels(factor(cod.df.females$state.gdiff.order.2))
y.num.breaks.2 <- length(levels(factor(cod.df.females$state.gdiff.order.2)))

females.era2 <- ggplotly(
  ggplot(subset(cod.df.females, era == "1983-1993"), aes(y = state.gdiff.num.2, x = new.start.2)) +
    geom_rect(aes(xmin = new.start.2, ymin = state.gdiff.num.2 - 0.45, 
                  ymax = state.gdiff.num.2 + 0.45, 
                  xmax = new.finish.2, fill = COD), 
              color = "white") +
    geom_segment(data = bw_dat.females,
                 aes(x = third.gap, xend = third.gap, y = state.gdiff.num.2 - 0.5, yend = state.gdiff.num.2 + 0.5)) +
    geom_segment(data = bw_dat.females,
                 aes(x = second.gap, xend = second.gap, y = state.gdiff.num.2 - 0.5, yend = state.gdiff.num.2 + 0.5), lty = 3) +
    theme_minimal() + scale_y_continuous(breaks = 1:y.num.breaks.2, labels = y.labels.2)) %>%
  layout(xaxis = list(title = "Life expectancy gap (years): 1983-1993"), yaxis = list(title = NA, autorange = "reversed"))

females.era2
```

**Figure 2c: Decomposition of the change in the female black-white life expectancy gap by cause of death between 1993 and 2013 by US state**

```{r figure2c, fig.align = "center", echo=F}
y.labels.3 <- levels(factor(cod.df.females$state.gdiff.order.3))
y.num.breaks.3 <- length(levels(factor(cod.df.females$state.gdiff.order.3)))

females.era3 <- ggplotly(
  ggplot(subset(cod.df.females, era == "1993-2013"), aes(y = state.gdiff.num.3, x = new.start.3)) +
    geom_rect(aes(xmin = new.start.3, ymin = state.gdiff.num.3 - 0.45, 
                  ymax = state.gdiff.num.3 + 0.45, 
                  xmax = new.finish.3, fill = COD), 
              color = "white") +
    geom_segment(data = bw_dat.females,
                 aes(x = fourth.gap, xend = fourth.gap, y = state.gdiff.num.3 - 0.5, yend = state.gdiff.num.3 + 0.5)) +
    geom_segment(data = bw_dat.females,
                 aes(x = third.gap, xend = third.gap, y = state.gdiff.num.3 - 0.5, yend = state.gdiff.num.3 + 0.5), lty = 3) +
    theme_minimal() + scale_y_continuous(breaks = 1:y.num.breaks.3, labels = y.labels.3)) %>%
  layout(xaxis = list(title = "Life expectancy gap (years): 1993-2013"), yaxis = list(title = NA, autorange = "reversed"))

females.era3
```

###Supplemental Information

**eTable1: Cause of Death Recode**

| Broad cause of death     | Included causes of death                                                     |
|--------------------------|------------------------------------------------------------------------------|
| Cancers                   | Lip; Tongue; Salivary gland; Floor of mouth; Gum and other mouth; Nasopharnyx; Tonsil; Oropharynx; Hypopharynx; Other oral cavity and pharynx; Esophagus; Stomach; Small intestine; Colon excluding rectum; Rectum and rectosigmoid junction; Anus, anal canal and anorectum; Liver; Intrahepatic bile duct; Gallbladder; Other biliary; Pancreas; Retroperitoneum; Peritoneum, Omentum and mesentery; Other digestive organs; Nose, nasal cavity and middle ear; Larynx; Lung and bronchus; Pleura; Trachea, Mediastinum and other respiratory organs; Bones and joints; Soft tissue including heart; Melanoma of the skin; Non-melanoma skin; Breast; Cervix uteri; Corpus uteri; Uterus, NOS; Ovary; Vagina; Vulva; Other female genital organs; Prostate; Testis; Penis; Other male genital organs; Urinary bladder; Kidney and renal pelvis; Ureter; Other urinary organs; Eye and orbit; Brain and other nervous system; Thyroid; Other endocrine including thymus; Hodkin lymphoma; Myeloma; Acute lymphocytic leukemia; Chronic lymphocytic leukemia; Other lymphocytic leukemia; Acute myeloid leukemia; Acute monocytic leukemia; Chronic myeloid leukemia; Other myeliod/monocytic leukemia; Other acute leukemia; Aleukemic, Subleukemic and NOS; Miscellaneous malignant cancer. |
| Cardiovascular disease   | Diseases of heart; Hypertension without heart disease; Cerebrovascular diseases; Atherosclerosis; Aortic aneurysm and dissection; Other diseases of arteries, arterioles, capillaries. | 
| Communicable disease     | Tuberculosis; Syphilis; HIV (1987+), Septicemia; Other infectious and parasitic diseases; Pneumonia and influenza |
| Non-communicable disease | Diabetes Mellitus; Alzheimers (ICD9 and 10 only); Chronic obstructive pulmonary disease and allied conditions; Stomach and duodenal ulcers; Chronic liver disease and cirrhosis; Nephritis, Nephrotic Sydrome and Nephrosis.  |
| Injuries                 | Accidents and Adverse Effects; Suicide and Self-inflicted Injury; Homicide and Legal Intervention. |
| All other causes         | Complications of pregnancy, childbirth, puerperium; Congenital anomalies; Certain conditions originating in perinatal period; Symptoms, signs, and ill-defined conditions; Other cause of death. |


**eFigure 1: Difference in life expectancy between black in white males, United States, 1969-2013**

![Difference in life expectancy between black in white males, United States, 1969-2013.](/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Manuscript/export.graph.Men.bmp)

**eFigure 2: Difference in life expectancy between black in white females, United States, 1969-2013**

![Difference in life expectancy between black in white females, United States, 1969-2013.](/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Manuscript/export.graph.Women.bmp)

**eExample 1: Decomposing the change to the difference in life expectancy over time by cause of death: an example**

To create.

**eFigure 3: Comparison of the contribution of age and cause of death to the difference in life expectancy between blacks and whites in New York, 1969 vs. 1983**

```{r ny_1969_1983_age_cod_decomp, echo = F, fig.width = 9}
ny.dat <- age_cod_results %>% filter(state == "New York" & year %in% c(1969, 1983, 1993) & sex == "Male") %>% 
                                     mutate(sign.var = sign(age_COD_cont_yrs))

ny.1969 <- make_pretty_decomp_plot(decomp.table = subset(ny.dat, year == 1969), sign.var = "sign.var",
                                  strat.var.1 = "age_minbin", partition.bar.var = "COD", decomp.var = "age_COD_cont_yrs",
                                  decomp.var.prop = "age_COD_cont_prop", type.of.data = "practice")
ny.1983 <- make_pretty_decomp_plot(decomp.table = subset(ny.dat, year == 1983), sign.var = "sign.var",
                                  strat.var.1 = "age_minbin", partition.bar.var = "COD", decomp.var = "age_COD_cont_yrs",
                                  decomp.var.prop = "age_COD_cont_prop", type.of.data = "practice")
ny.1993 <- make_pretty_decomp_plot(decomp.table = subset(ny.dat, year == 1993), sign.var = "sign.var",
                                  strat.var.1 = "age_minbin", partition.bar.var = "COD", decomp.var = "age_COD_cont_yrs",
                                  decomp.var.prop = "age_COD_cont_prop", type.of.data = "practice")

ggplotly(ggplot(rbind(ny.1969, ny.1983, ny.1993),
                aes(y = age, x = start)) + 
           geom_segment(aes(xend = finish, col = COD, yend = age), lwd = 3) +
           xlab(paste0("Contribution to life expectancy gap in years")) +
           ylab("Age group\n") + theme_minimal() +
           geom_vline(xintercept = 0) + 
           facet_wrap(~ year)) 
            
```

**Pennsylvania**
```{r pa_1993_1983_age_cod_decomp, echo = F, fig.width = 9}
pa.dat <- age_cod_results %>% filter(state == "Pennsylvania" & year %in% c(1969, 1983, 1993) & sex == "Male") %>% 
                                     mutate(sign.var = sign(age_COD_cont_yrs))

pa.1993 <- make_pretty_decomp_plot(decomp.table = subset(pa.dat, year == 1993), sign.var = "sign.var",
                                  strat.var.1 = "age_minbin", partition.bar.var = "COD", decomp.var = "age_COD_cont_yrs",
                                  decomp.var.prop = "age_COD_cont_prop", type.of.data = "practice")
pa.1983 <- make_pretty_decomp_plot(decomp.table = subset(pa.dat, year == 1983), sign.var = "sign.var",
                                  strat.var.1 = "age_minbin", partition.bar.var = "COD", decomp.var = "age_COD_cont_yrs",
                                  decomp.var.prop = "age_COD_cont_prop", type.of.data = "practice")

ggplotly(ggplot(rbind(pa.1993, pa.1983),
                aes(y = age, x = start)) + 
           geom_segment(aes(xend = finish, col = COD, yend = age), lwd = 3) +
           xlab(paste0("Contribution to life expectancy gap in years")) +
           ylab("Age group\n") + theme_minimal() +
           geom_vline(xintercept = 0) + 
           facet_wrap(~ year)) 
```

**Connecticut**
```{r ct_1993_1983_age_cod_decomp, echo = F, fig.width = 9}
ct.dat <- age_cod_results %>% filter(state == "Connecticut" & year %in% c(1969, 1983, 1993) & sex == "Male") %>% 
                                     mutate(sign.var = sign(age_COD_cont_yrs))

ct.1993 <- make_pretty_decomp_plot(decomp.table = subset(ct.dat, year == 1993), sign.var = "sign.var",
                                  strat.var.1 = "age_minbin", partition.bar.var = "COD", decomp.var = "age_COD_cont_yrs",
                                  decomp.var.prop = "age_COD_cont_prop", type.of.data = "practice")
ct.1983 <- make_pretty_decomp_plot(decomp.table = subset(ct.dat, year == 1983), sign.var = "sign.var",
                                  strat.var.1 = "age_minbin", partition.bar.var = "COD", decomp.var = "age_COD_cont_yrs",
                                  decomp.var.prop = "age_COD_cont_prop", type.of.data = "practice")

ggplotly(ggplot(rbind(ct.1993, ct.1983),
                aes(y = age, x = start)) + 
           geom_segment(aes(xend = finish, col = COD, yend = age), lwd = 3) +
           xlab(paste0("Contribution to life expectancy gap in years")) +
           ylab("Age group\n") + theme_minimal() +
           geom_vline(xintercept = 0) + 
           facet_wrap(~ year)) 
```

**Mississippi**
```{r ms_1993_1983_age_cod_decomp, echo = F, fig.width = 9}
ms.dat <- age_cod_results %>% filter(state == "Mississippi" & year %in% c(1969, 1983, 1993) & sex == "Male") %>% 
                                     mutate(sign.var = sign(age_COD_cont_yrs))

ms.1993 <- make_pretty_decomp_plot(decomp.table = subset(ms.dat, year == 1993), sign.var = "sign.var",
                                  strat.var.1 = "age_minbin", partition.bar.var = "COD", decomp.var = "age_COD_cont_yrs",
                                  decomp.var.prop = "age_COD_cont_prop", type.of.data = "practice")
ms.1983 <- make_pretty_decomp_plot(decomp.table = subset(ms.dat, year == 1983), sign.var = "sign.var",
                                  strat.var.1 = "age_minbin", partition.bar.var = "COD", decomp.var = "age_COD_cont_yrs",
                                  decomp.var.prop = "age_COD_cont_prop", type.of.data = "practice")

ggplotly(ggplot(rbind(ms.1993, ms.1983),
                aes(y = age, x = start)) + 
           geom_segment(aes(xend = finish, col = COD, yend = age), lwd = 3) +
           xlab(paste0("Contribution to life expectancy gap in years")) +
           ylab("Age group\n") + theme_minimal() +
           geom_vline(xintercept = 0) + 
           facet_wrap(~ year)) 
```

**Florida**
```{r fl_1993_1983_age_cod_decomp, echo = F, fig.width = 9}
fl.dat <- age_cod_results %>% filter(state == "Florida" & year %in% c(1969, 1983, 1993) & sex == "Male") %>% 
                                     mutate(sign.var = sign(age_COD_cont_yrs))

fl.1993 <- make_pretty_decomp_plot(decomp.table = subset(fl.dat, year == 1993), sign.var = "sign.var",
                                  strat.var.1 = "age_minbin", partition.bar.var = "COD", decomp.var = "age_COD_cont_yrs",
                                  decomp.var.prop = "age_COD_cont_prop", type.of.data = "practice")
fl.1983 <- make_pretty_decomp_plot(decomp.table = subset(fl.dat, year == 1983), sign.var = "sign.var",
                                  strat.var.1 = "age_minbin", partition.bar.var = "COD", decomp.var = "age_COD_cont_yrs",
                                  decomp.var.prop = "age_COD_cont_prop", type.of.data = "practice")

ggplotly(ggplot(rbind(fl.1993, fl.1983),
                aes(y = age, x = start)) + 
           geom_segment(aes(xend = finish, col = COD, yend = age), lwd = 3) +
           xlab(paste0("Contribution to life expectancy gap in years")) +
           ylab("Age group\n") + theme_minimal() +
           geom_vline(xintercept = 0) + 
           facet_wrap(~ year)) 
```



**Things for corinne to review**

- CVD declining starting 1968 - see paper Ruel Stallones - cited in SH JAMA paper - history of decline in CVD.

- Richard cooper also written about BW diff in CVD with epi perspective
