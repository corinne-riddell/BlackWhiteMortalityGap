---
title: "Exploring how changes in age at death and cause of death have narrowed the black-white life expectancy gap over forty-five years in the United States."
output: html_document
---

##Riddell CA, Morrison KT, Kaufman JS, Harper S 

###Abstract

###Introduction
The life expectancy of a population serves as a barometer for overall health. In 2014, life expectancy in the United States was 78.7 years, but hidden within this figure, are differences in life expectancy by race. Non-hispanic whites lived 3.6 years longer than non-hispanic blacks [ref: http://www.cdc.gov/nchs/data/nvsr/nvsr65/nvsr65_04.pdf]. While both black and white americans have experienced increases in life expectancy since X, the difference between their life expectancies has varied. During the 1980s, the life expectancy gap widened and then narrowed in the 1990s due to relative mortality improvements among blacks in deaths due to homicide, HIV, unintentional injuries, and, among females, heart disease [Harper 2007]. The gap continued to narrow during the 2000s, but states differed in the magnitude of improvement that was made. For example, the life expectancy gap in New York decreased from 8.0 years to 2.4 years between 1990 and 2009, but in California the decrease was much more modest -- from 6.7 years to 5.6 years [Harper 2014]. This study seeks to better understand these state-level differences, by examining how changes in age at death and cause of death over time have worked to narrow or exacerbate the life expectancy gap.

**Background notes from meeting with SH on Dec 20**
-CVD declining starting 1968 - see paper Ruel Stallones - cited in SH JAMA paper - history of decline in CVD.
-Richard cooper also written about BW diff in CVD with epi perspective
-for men there is stagnation from 1969 to late 1980s and then increase in gap with HIV and homicides
-massive crime wave in 1980s, black LE went down from 1984 to 1987 - period when both HIV and homicide went up -- the whole story during that time was HIV and homicide
-fundamentally interested in the qu is there a common story across most states or are there important differences in what happened in NY vs CA vs TX - can we say anything about what we know about state-specific policies, for example CA has strong anti-smoking legislation. Does this help us understand why the gap in Wisconsin was increasing?
-is there a lot of heterogeneity or is there not? - same something about the proportionate contribution by COD and by age - e.g., changes in injuries accounting for X% for closing the gap in NY but in AL it was Y%.
-heterogeneity between states in the contribution of the causes to the decline in the gap - maybe need to break up into at least two time periods with split at 1990.
-this is where the new figures come in which on the y-axis have the contribution to LE gap (in years or %) vs year on the x axis, and geom_line for each COD (do one COD at a time), and individual line for each state (may facet by census region).
-then have a view of how the different COD have contributed to the decline in the gap over time. 

###Methods

**The data**

We used software maintained by the National Cancer Institute's Surveillance, Epidemiology, and End Results Program (SEER*Stat) to extract data on the number of deaths and the population size in all 50 US states and the District of Columbia. The mortality data was originally collected by the National Center for Health Statistics (NCHS) from death certificates and stored by the National Vital Statistics System. The population data was derived by the NCHS using intercensal bridged-race population estimates. This study using data on the number of deaths and the population size according to race (black or white), sex (male or female), age group (<1 year old, 1-4 years old, followed by 5-year age groupings, with a final grouping of 85 or more years of age), year (1969 -- 2013), and cause of death. Cause of death was originally recorded using the International Classification of Diseases (ICD) codes versions 8 (1969-1979), 9 (1979-1998), and 10 (1999-2013). These codes were then grouped into 9X causes of death within the software, which we further aggregated into six broad causes of death for this analysis: Cancers, Cardiovascular disease, Communicable disease, Injuries, Non-communicable disease, and All other causes. This recoding is illustrated in eTable 1 in the eAppendix of the Supplement. When the number of deaths for a population is between 1 and 9, this data is suppressed by the software and produces a missing death count for that strata. However, death counts of exactly 0 or greater than 9 are known precisely. 

- CR to add line about which states were not considered.
- CR to add line about hispanic origin. 

**Statistical Methods**

The data produced two statistical issues that were addressed by our statistical methods. First, our methodology needed to impute the missing death counts. Second, several states had small blacks populations which produced even smaller population sizes in each sex-age category. In these cases, the estimation of the sex-age mortality rates is imprecise, and produces abrupt changes in the estimation of mortality rates over time that are unrealistic. To better estimate the underlying age-specific mortality rates, a method that produces smoother age-specific mortality trends was required.

To address these challenges, we used a Bayesian autoregressive model to smooth the data over time, and incorporated a truncated Poisson model to impute the suppressed death counts. Specifically, we used Poisson regression to model the number of deaths in each state-age-sex-race-year category as a function of the at-risk population. The mortality rates over time within each state-age-sex-race category are modelled autoregressively, where the log mortality rate in the current year was modelled as a normal variable centred at the log mortality rate estimated from the previous year. Truncated Poisson regression was used to impute the supressed death counts, by specifying that the supressed counts were sampled from a Poisson distribution and were constrained to be between 1 and the maximum of 9 and the at-risk population size (which may be smaller than 9). These models were run separately for every combination of state, race, and sex, and produced death counts that had been smoothed over time for every cause of death within each age group.

To calculate life expectancy at birth, the smoothed death counts were aggregated to estimate the total deaths in each age group and standard life table methods were applied [ref]. Life expectancy at birth (in years) was calculated for blacks and whites in each state and year according to sex. The difference in life expectancies between blacks and white was calculated by subtracting the black life expectancy from the white life expectancy in every state, year, and sex.

To decompose the black-white difference in life expectancy, we performed a decomposition analysis using the Arriaga method [ref]. First, the decomposition analysis partitions the difference in life expectancy by age group, which can be interpreted as the amount of the gap (in years) that can be attributed to higher age-specific mortality rates in blacks. For example, a decomposition of a gap of five years may find that two of the five years (40% of the gap) is attributable to a higher mortality rate in blacks in the youngest age group (< 1 years old) compared with the youngest whites. This age-specific decomposition can be further partitioned according to cause of death, producing the number of years of the gap that is attributable to every age- and cause-of-death combination. For example, a decomposition of a gap of 8 years may find that 1.3 years of this gap is attributable to more injury-related deaths in blacks aged 25-29 years old. We also summed these age- and cause-of-death partitions over all ages to calculate the marginal contribution of each cause-of-death to the difference.

**Will need to change the following**
Finally, we calculated the change in the life expectancy gap over time within each state-, race-, and sex-specific stratum. The change in the life expectancy gap is calculated by substracting the gap that occurred in the later year from the gap that occurred in the earlier year. This change in gap can be decomposed by age by taking the difference in the age-specfic contributions across the two years, and can similarly be calculated by cause.

All data analyses were performed using R version 3.3.1. The bayesian smoothing was performed using `JAGS` (version X.X), and the life expectnacy and decomposition analysis were performed using user-written functions found in the Supplement. 

**Add in the stuff about precision**
- sampled from posterior distribution with thinning
- software: R software packages and their versions



###Results

```{r initialize, echo=FALSE, warning=F, message=F}
library(shiny)
library(plotly)
library(viridis)
library(scales)
library(shinythemes)
library(dplyr)
load(file = "/Users/corinneriddell/Dropbox/BlackWhiteGap/Data/main_datasets.Rdata")
source("/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Code/life_expectancy_functions.R")
```

```{r setup_figure1_and_3_males, echo=F}
year1 <- 1969
year2 <- 2013
sex <- "Male"

bw_dat <- BlackWhite %>% 
  filter(Year3 %in% c(year1, year2), Sex2 == sex, is.na(WBgap.s) == F) %>%
  select(State2, Year3, WBgap.s) %>%
  arrange(Year3)

bw_dat <- tidyr::spread(bw_dat, Year3, WBgap.s) 
names(bw_dat)[2:3] <- c("first.gap","second.gap")  
bw_dat <- bw_dat %>% mutate(gap.diff = first.gap - second.gap,
                            State.gdiff.order = reorder(State2, first.gap),
                            State.gdiff.num = as.numeric(State.gdiff.order)
)

cod.df <- data.frame(State2 = factor(), COD = factor(), Contribution.to.change = numeric(), Contrib.to.change.prop = numeric(), narrowed_gap = logical())
age.df <- data.frame(State2 = factor(), Ages = factor(), Contribution.to.change = numeric(), Contrib.to.change.prop = numeric(), narrowed_gap = logical())
    
for (state.i in levels(BlackWhite$State2)) {
  
  first.index = which(paired.ids$State2 ==  state.i & paired.ids$Year3 == year1 & paired.ids$Sex2 == sex)
  second.index = which(paired.ids$State2 ==  state.i & paired.ids$Year3 == year2 & paired.ids$Sex2 == sex)
  
  if(is.null(list.cod.marginal.tables.smoothed[[first.index]][1]) == FALSE & 
     is.null(list.cod.marginal.tables.smoothed[[second.index]][1]) == FALSE) {
    
    temp2 <- data.frame(State2 = state.i, Sex2 = sex,
                        contribution.to.gap.change(type.of.decomp = "COD",
                                                   list.cod.marginal.tables.smoothed[[first.index]],
                                                   list.cod.marginal.tables.smoothed[[second.index]])
    )
    
    temp3 <- data.frame(State2 = state.i, Sex2 = sex,
                        contribution.to.gap.change(type.of.decomp = "Age",
                                                   list.age.decomp.tables.smoothed[[first.index]],
                                                   list.age.decomp.tables.smoothed[[second.index]])
    )
    
    cod.df <- rbind(cod.df, temp2)
    age.df <- rbind(age.df, temp3)
  }
  
}

##### COD ####
cod.df<- make_dataset_cod_plot(cod.decomp.table = cod.df, age.groups = "State2", 
                                 cause.of.death = "COD", sign.var = "narrowed_gap", 
                                 decomp.var = "Contribution.to.change", decomp.var.prop = "Contrib.to.change.prop")

cod.df <- merge(cod.df, bw_dat, by = c("State2"))

cod.df <- cod.df %>% mutate(new.start = -start + first.gap, new.finish = -finish + first.gap)

#### Age ####
age.df <- make_dataset_cod_plot(cod.decomp.table = age.df, age.groups = "State2", 
                                  cause.of.death = "Ages", sign.var = "narrowed_gap", 
                                  decomp.var = "Contribution.to.change", decomp.var.prop = "Contrib.to.change.prop")

age.df <- merge(age.df, bw_dat, by = "State2")

age.df <- age.df %>% mutate(new.start = -start + first.gap, new.finish = -finish + first.gap)
```

```{r setup_figure1_and_3_females, echo=F}
sex <- "Female"

bw_dat.f <- BlackWhite %>% 
  filter(Year3 %in% c(year1, year2), Sex2 == sex, is.na(WBgap.s) == F) %>%
  select(State2, Year3, WBgap.s) %>%
  arrange(Year3)

bw_dat.f <- tidyr::spread(bw_dat.f, Year3, WBgap.s) 
names(bw_dat.f)[2:3] <- c("first.gap","second.gap")  
bw_dat.f <- bw_dat.f %>% mutate(gap.diff = first.gap - second.gap,
                            State.gdiff.order = reorder(State2, first.gap),
                            State.gdiff.num = as.numeric(State.gdiff.order)
)

cod.df.f <- data.frame(State2 = factor(), COD = factor(), Contribution.to.change = numeric(), Contrib.to.change.prop = numeric(), narrowed_gap = logical())
age.df.f <- data.frame(State2 = factor(), Ages = factor(), Contribution.to.change = numeric(), Contrib.to.change.prop = numeric(), narrowed_gap = logical())
    
for (state.i in levels(BlackWhite$State2)) {
  
  first.index = which(paired.ids$State2 ==  state.i & paired.ids$Year3 == year1 & paired.ids$Sex2 == sex)
  second.index = which(paired.ids$State2 ==  state.i & paired.ids$Year3 == year2 & paired.ids$Sex2 == sex)
  
  if(is.null(list.cod.marginal.tables.smoothed[[first.index]][1]) == FALSE & 
     is.null(list.cod.marginal.tables.smoothed[[second.index]][1]) == FALSE) {
    
    temp2 <- data.frame(State2 = state.i, Sex2 = sex,
                        contribution.to.gap.change(type.of.decomp = "COD",
                                                   list.cod.marginal.tables.smoothed[[first.index]],
                                                   list.cod.marginal.tables.smoothed[[second.index]])
    )
    
    temp3 <- data.frame(State2 = state.i, Sex2 = sex,
                        contribution.to.gap.change(type.of.decomp = "Age",
                                                   list.age.decomp.tables.smoothed[[first.index]],
                                                   list.age.decomp.tables.smoothed[[second.index]])
    )
    
    cod.df.f <- rbind(cod.df.f, temp2)
    age.df.f <- rbind(age.df.f, temp3)
  }
  
}

##### COD ####
cod.df.f <- make_dataset_cod_plot(cod.decomp.table = cod.df.f, age.groups = "State2", 
                                 cause.of.death = "COD", sign.var = "narrowed_gap", 
                                 decomp.var = "Contribution.to.change", decomp.var.prop = "Contrib.to.change.prop")

cod.df.f <- merge(cod.df.f, bw_dat.f, by = c("State2"))

cod.df.f <- cod.df.f %>% mutate(new.start = -start + first.gap, new.finish = -finish + first.gap)

#### Age ####
age.df.f <- make_dataset_cod_plot(cod.decomp.table = age.df.f, age.groups = "State2", 
                                  cause.of.death = "Ages", sign.var = "narrowed_gap", 
                                  decomp.var = "Contribution.to.change", decomp.var.prop = "Contrib.to.change.prop")

age.df.f <- merge(age.df.f, bw_dat.f, by = "State2")

age.df.f <- age.df.f %>% mutate(new.start = -start + first.gap, new.finish = -finish + first.gap)
```

Update the below text to also represent women:
**Figure 1** displays each state's male life expectancy gap in 1969 (vertical dashed line) vs. their gap in 2013 (solid dashed line), with the change in the gap being represented by the number of years between these lines. The decomposition (in years) of the change in the gap by cause of death is also shown for each state. In the US, X of Y years of the change in gap is attributable to injuries, implying relatively more favourable *changes* to injury-related mortality rates in blacks vs. whites. The next large contributor to reducing the overall gap was "All other causes", which largely represents infant mortality and maternal mortality in our analysis (CR to confirm this). Blacks also saw relatively favourable changes in death related to communicable diseases, wher X of Y years of the change in the gap is attributable to changes in communicable disease-related mortality. Overall, X of Y years of the gap is attributable to cardiovarscular disease, but the story is very different by state. For example, California and Washington both underwent large unfavourable changes to CVD-related mortality among blacks relative to whites, where these conditions served to limit the change in the gap in California (which would have been much larger had CVD-related mortality rates had changed more favourably) and led to a much larger gap in the District of Columbia in 2013 vs. 1969, where X of Y years of the increase in the gap is attributable to CVD-related mortality.

**Figure 1: Decomposition of the change in the male black-white life expectancy gap by cause of death between 1969 and 2013 by US state**
```{r figure1, fig.align = "center", fig.height=8, fig.width=8, echo=F}
x.labels <- levels(factor(cod.df$State.gdiff.order))
x.num.breaks <- length(levels(factor(cod.df$State.gdiff.order)))

ggplotly(
  ggplot(cod.df, aes(y = State.gdiff.num, x = new.start)) +
    geom_rect(aes(xmin = new.start, ymin = State.gdiff.num - 0.45, 
                  ymax = State.gdiff.num + 0.45, xmax = new.finish, fill = COD), color = "white") +
    geom_segment(data = bw_dat, aes(x = second.gap, xend= second.gap, y = State.gdiff.num - 0.5, yend = State.gdiff.num + 0.5)) +
    geom_segment(data = bw_dat, aes(x = first.gap, xend= first.gap, y = State.gdiff.num - 0.5, yend = State.gdiff.num + 0.5), lty = 3) +
    theme_minimal() + scale_y_continuous(breaks = 1:x.num.breaks, labels = x.labels)) %>% 
  layout(xaxis = list(title = "Life expectancy gap (years)"), yaxis = list(title = NA, autorange = "reversed"))

```
**This figure depicts how the gap in life expectancy for Males changed between 1969 (dashed vertical line) and 2013 (solid vertical line). Causes to the left of the dashed line narrowed the gap over time, whereas causes to the right exacerbated it.**

**Figure 2: Decomposition of the change in the female black-white life expectancy gap by cause of death between 1969 and 2013 by US state**
```{r figure2, fig.align = "center", fig.height=8, fig.width=8, echo=F}
x.labels.f <- levels(factor(cod.df.f$State.gdiff.order))
x.num.breaks.f <- length(levels(factor(cod.df.f$State.gdiff.order)))

ggplotly(
  ggplot(cod.df.f, aes(y = State.gdiff.num, x = new.start)) +
    geom_rect(aes(xmin = new.start, ymin = State.gdiff.num - 0.45, 
                  ymax = State.gdiff.num + 0.45, xmax = new.finish, fill = COD), color = "white") +
    geom_segment(data = bw_dat.f, aes(x = second.gap, xend= second.gap, y = State.gdiff.num - 0.5, yend = State.gdiff.num + 0.5)) +
    geom_segment(data = bw_dat.f, aes(x = first.gap, xend= first.gap, y = State.gdiff.num - 0.5, yend = State.gdiff.num + 0.5), lty = 3) +
    theme_minimal() + scale_y_continuous(breaks = 1:x.num.breaks.f, labels = x.labels.f)) %>% 
  layout(xaxis = list(title = "Life expectancy gap (years)"), yaxis = list(title = NA, autorange = "reversed"))

```

**Figure 3: Decomposition of the change in the male black-white life expectancy gap by cause of death between 1969 and 2013 by US state**
```{r figure3, fig.align = "center", fig.height=8, fig.width=9, echo=F}
ggplotly(                                     
  ggplot(age.df, aes(y = State.gdiff.num, x = new.start)) +
    geom_rect(aes(xmin = new.start, ymin = State.gdiff.num - 0.45, ymax = State.gdiff.num + 0.45, xmax = new.finish, fill = Ages), color = "white") + 
    geom_segment(data = bw_dat, aes(x = second.gap, xend= second.gap, y = State.gdiff.num - 0.5, yend = State.gdiff.num + 0.5)) + 
    geom_segment(data = bw_dat, aes(x = first.gap, xend= first.gap, y = State.gdiff.num - 0.5, yend = State.gdiff.num + 0.5), lty = 3) + 
    theme_minimal() + scale_y_continuous(breaks = 1:x.num.breaks, labels = x.labels) + scale_fill_viridis(discrete = T, direction = -1)) %>% 
  layout(xaxis = list(title = "Life expectancy gap (years)"), yaxis = list(title = NA, autorange = "reversed")
  )
```

**Figure 4: Decomposition of the change in the female black-white life expectancy gap by cause of death between 1969 and 2013 by US state**
```{r figure4, fig.align = "center", fig.height=8, fig.width=9, echo=F}
ggplotly(                                     
  ggplot(age.df.f, aes(y = State.gdiff.num, x = new.start)) +
    geom_rect(aes(xmin = new.start, ymin = State.gdiff.num - 0.45, ymax = State.gdiff.num + 0.45, xmax = new.finish, fill = Ages), color = "white") + 
    geom_segment(data = bw_dat.f, aes(x = second.gap, xend= second.gap, y = State.gdiff.num - 0.5, yend = State.gdiff.num + 0.5)) + 
    geom_segment(data = bw_dat.f, aes(x = first.gap, xend= first.gap, y = State.gdiff.num - 0.5, yend = State.gdiff.num + 0.5), lty = 3) + 
    theme_minimal() + scale_y_continuous(breaks = 1:x.num.breaks.f, labels = x.labels.f) + scale_fill_viridis(discrete = T, direction = -1)) %>% 
  layout(xaxis = list(title = "Life expectancy gap (years)"), yaxis = list(title = NA, autorange = "reversed")
  )
```

**Figure 5: Trends in the black-white life expectancy gap for males between 1969 and 2013 by US state**

```{r figure5, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(BlackWhite, Sex2 == "Male"), aes(y=WBgap.s, x = Year3)) + geom_line(aes(col = State2))
         + facet_wrap( ~ Census_Region) +
           ylab("Black-white life expectancy gap (years)") +
           xlab("Year") +
           geom_text(data = subset(BlackWhite, Year3 == 2013 & Sex2 == "Male"), aes(label = stabbrs), check_overlap = T, size = 2.5) 
         ) 
```

**Figure 6: Trends in the black-white life expectancy gap for females between 1969 and 2013 by US state**

```{r figure6, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(BlackWhite, Sex2 == "Female"), aes(y=WBgap.s, x = Year3)) + geom_line(aes(col = State2))
         + facet_wrap(~Census_Region) +
           ylab("Black-white life expectancy gap (years)") +
           xlab("Year") +
           geom_text(data = subset(BlackWhite, Year3 == 2013 & Sex2 == "Female"), aes(label = stabbrs), check_overlap = T, size = 2.5)
)
```

**Figure 7a: Contribution of cancer to the black-white life expectancy gap for males between 1969 and 2013 by US state, in years**
```{r figure7a, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == "Cancers"), aes(x = Year3, y = C_x_COD)) + 
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (years)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2013 & Sex2 == "Male" & Cause.of.death == "Cancers"), 
         aes(label = stabbrs), check_overlap = T, size = 2.5)
)


    #theme_grey(base_size = 9) + labs(x = "", y = "") + 
    #scale_x_discrete(expand = c(0, 0)) +
    #scale_y_discrete(expand = c(0, 0)) +
    #theme(legend.position = "none", axis.ticks = element_blank(), axis.text.x = element_text(size = 9*0.8, angle = 330, hjust = 0, colour = "grey50")) 

ggplotly(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == "Cancers"), aes(x = Year3, y = C_x_COD_proportion)) +
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (years)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2013 & Sex2 == "Male" & Cause.of.death == "Cancers"),
         aes(label = stabbrs), check_overlap = T, size = 2.5))
#the wonky percent contributions occur in the states where the LE gap crosses 0 years.

ggplotly(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == "Cancers" & C_x_COD_proportion < 0.5 & C_x_COD_proportion > -0.5), aes(x = Year3, y = C_x_COD_proportion)) +
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (%)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2000 & Sex2 == "Male" & Cause.of.death == "Cancers"),
         aes(label = stabbrs), check_overlap = T, size = 2.5))
```

**Figure 7b: Contribution of cardiovascular disease to the black-white life expectancy gap for males between 1969 and 2013 by US state, in years**
```{r figure7b, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == "Cardiovascular"), aes(x = Year3, y = C_x_COD)) + 
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (years)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2013 & Sex2 == "Male" & Cause.of.death == "Cardiovascular"), aes(label = stabbrs), check_overlap = T, size = 2.5)
)

ggplotly(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == "Cardiovascular" & C_x_COD_proportion < 0.5 & C_x_COD_proportion > -0.5), aes(x = Year3, y = C_x_COD_proportion)) +
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (%)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2000 & Sex2 == "Male" & Cause.of.death == "Cardiovascular"),
         aes(label = stabbrs), check_overlap = T, size = 2.5))
```

**Figure 7c: Contribution of communicable disease to the black-white life expectancy gap for males between 1969 and 2013 by US state, in years**

```{r figure7c, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == "Communicable"), aes(x = Year3, y = C_x_COD)) + 
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (years)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2013 & Sex2 == "Male" & Cause.of.death == "Communicable"), aes(label = stabbrs), check_overlap = T, size = 2.5)
)

ggplotly(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == "Communicable" & C_x_COD_proportion < 0.5 & C_x_COD_proportion > 0), aes(x = Year3, y = C_x_COD_proportion)) +
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (%)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2000 & Sex2 == "Male" & Cause.of.death == "Communicable"),
         aes(label = stabbrs), check_overlap = T, size = 2.5))
```

**Figure 7d: Contribution of non-communicable disease to the black-white life expectancy gap for males between 1969 and 2013 by US state, in years**

```{r figure7d, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == "Non-communicable"), aes(x = Year3, y = C_x_COD)) + 
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (years)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2013 & Sex2 == "Male" & Cause.of.death == "Non-communicable"), aes(label = stabbrs), check_overlap = T, size = 2.5)
)

ggplotly(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == "Non-communicable" & C_x_COD_proportion < 0.5 & C_x_COD_proportion > 0), aes(x = Year3, y = C_x_COD_proportion)) +
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (%)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2000 & Sex2 == "Male" & Cause.of.death == "Non-communicable"),
         aes(label = stabbrs), check_overlap = T, size = 2.5))
```

**Figure 7e: Contribution of injuries to the black-white life expectancy gap for males between 1969 and 2013 by US state, in years**

```{r figure7e, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == "Injuries"), aes(x = Year3, y = C_x_COD)) + 
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (years)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2013 & Sex2 == "Male" & Cause.of.death == "Injuries"), aes(label = stabbrs), check_overlap = T, size = 2.5)
)

ggplotly(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == "Injuries" & C_x_COD_proportion < 0.5 & C_x_COD_proportion > 0), aes(x = Year3, y = C_x_COD_proportion)) +
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (%)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2000 & Sex2 == "Male" & Cause.of.death == "Injuries"),
         aes(label = stabbrs), check_overlap = T, size = 2.5))
```

**Figure 7f: Contribution of all other causes to the black-white life expectancy gap for males between 1969 and 2013 by US state, in years**

```{r figure7f, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == "All other causes"), aes(x = Year3, y = C_x_COD)) + 
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (years)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2013 & Sex2 == "Male" & Cause.of.death == "All other causes"), aes(label = stabbrs), check_overlap = T, size = 2.5)
)

ggplotly(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == "All other causes" & C_x_COD_proportion < 0.5 & C_x_COD_proportion > 0), aes(x = Year3, y = C_x_COD_proportion)) +
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (%)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2000 & Sex2 == "Male" & Cause.of.death == "All other causes"),
         aes(label = stabbrs), check_overlap = T, size = 2.5))
```

**Figure 7g: Different way to portray the above data for males**

```{r figure7g, fig.align="center", fig.height=8, fig.width=9, echo=F}
for (cod in levels(cod.contributions$Cause.of.death)) {
  print(ggplot(subset(cod.contributions, Sex2 == "Male" & Cause.of.death == cod), aes(x = Year3, y = State2)) + 
          geom_tile(aes(fill = C_x_COD), col = "white") +
          facet_wrap(~ Census_Region, scales = "free_y") + 
          scale_fill_viridis() + theme_minimal() + 
          ylab("Contribution to LE Gap (years)") +
          xlab("Year") + ggtitle(cod))
}
```

**Figure 8a: Contribution of cancer to the black-white life expectancy gap for females between 1969 and 2013 by US state, in years**

```{r figure8a, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(cod.contributions, Sex2 == "Female" & Cause.of.death == "Cancers"), aes(x = Year3, y = C_x_COD)) + 
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (years)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2013 & Sex2 == "Female" & Cause.of.death == "Cancers"), 
         aes(label = stabbrs), check_overlap = T, size = 2.5)
)

ggplotly(ggplot(subset(cod.contributions, Sex2 == "Female" & Cause.of.death == "Cancers" & C_x_COD_proportion < 0.5 & C_x_COD_proportion > 0), aes(x = Year3, y = C_x_COD_proportion)) +
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (%)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2000 & Sex2 == "Male" & Cause.of.death == "Cancers"),
         aes(label = stabbrs), check_overlap = T, size = 2.5))
```

**Figure 8b: Contribution of cardiovascular disease to the black-white life expectancy gap for females between 1969 and 2013 by US state, in years**

```{r figure8b, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(cod.contributions, Sex2 == "Female" & Cause.of.death == "Cardiovascular"), aes(x = Year3, y = C_x_COD)) + 
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (years)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2013 & Sex2 == "Female" & Cause.of.death == "Cardiovascular"), 
         aes(label = stabbrs), check_overlap = T, size = 2.5)
)

ggplotly(ggplot(subset(cod.contributions, Sex2 == "Female" & Cause.of.death == "Cardiovascular" & C_x_COD_proportion < 0.5 & C_x_COD_proportion > 0), aes(x = Year3, y = C_x_COD_proportion)) +
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (%)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2000 & Sex2 == "Male" & Cause.of.death == "Cardiovascular"),
         aes(label = stabbrs), check_overlap = T, size = 2.5))
```

**Figure 8c: Contribution of communicable disease to the black-white life expectancy gap for females between 1969 and 2013 by US state, in years**

```{r figure8c, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(cod.contributions, Sex2 == "Female" & Cause.of.death == "Communicable"), aes(x = Year3, y = C_x_COD)) + 
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (years)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2013 & Sex2 == "Female" & Cause.of.death == "Communicable"), 
         aes(label = stabbrs), check_overlap = T, size = 2.5)
)

ggplotly(ggplot(subset(cod.contributions, Sex2 == "Female" & Cause.of.death == "Communicable" & C_x_COD_proportion < 0.5 & C_x_COD_proportion > 0), aes(x = Year3, y = C_x_COD_proportion)) +
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (%)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2000 & Sex2 == "Male" & Cause.of.death == "Communicable"),
         aes(label = stabbrs), check_overlap = T, size = 2.5))
```

**Figure 8d: Contribution of non-communicable disease to the black-white life expectancy gap for females between 1969 and 2013 by US state, in years**

```{r figure8d, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(cod.contributions, Sex2 == "Female" & Cause.of.death == "Non-communicable"), aes(x = Year3, y = C_x_COD)) + 
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (years)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2013 & Sex2 == "Female" & Cause.of.death == "Non-Communicable"), 
         aes(label = stabbrs), check_overlap = T, size = 2.5)
)

ggplotly(ggplot(subset(cod.contributions, Sex2 == "Female" & Cause.of.death == "Non-communicable" & C_x_COD_proportion < 0.5 & C_x_COD_proportion > 0), aes(x = Year3, y = C_x_COD_proportion)) +
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (%)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2000 & Sex2 == "Male" & Cause.of.death == "Non-communicable"),
         aes(label = stabbrs), check_overlap = T, size = 2.5))
```

**Figure 8e: Contribution of injuries to the black-white life expectancy gap for females between 1969 and 2013 by US state, in years**

```{r figure8e, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(cod.contributions, Sex2 == "Female" & Cause.of.death == "Injuries"), aes(x = Year3, y = C_x_COD)) + 
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (years)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2013 & Sex2 == "Female" & Cause.of.death == "Injuries"), 
         aes(label = stabbrs), check_overlap = T, size = 2.5)
)

ggplotly(ggplot(subset(cod.contributions, Sex2 == "Female" & Cause.of.death == "Injuries" & C_x_COD_proportion < 0.5 & C_x_COD_proportion > -0.2), aes(x = Year3, y = C_x_COD_proportion)) +
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (%)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2000 & Sex2 == "Male" & Cause.of.death == "Injuries"),
         aes(label = stabbrs), check_overlap = T, size = 2.5))
```

**Figure 8f: Contribution of all other causes to the black-white life expectancy gap for females between 1969 and 2013 by US state, in years**

```{r figure8f, fig.align="center", fig.height=8, fig.width=9, echo=F}
ggplotly(ggplot(subset(cod.contributions, Sex2 == "Female" & Cause.of.death == "All other causes"), aes(x = Year3, y = C_x_COD)) + 
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (years)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2013 & Sex2 == "Female" & Cause.of.death == "All other causes"), 
         aes(label = stabbrs), check_overlap = T, size = 2.5)
)

ggplotly(ggplot(subset(cod.contributions, Sex2 == "Female" & Cause.of.death == "All other causes" & C_x_COD_proportion < 0.5 & C_x_COD_proportion > -0.2), aes(x = Year3, y = C_x_COD_proportion)) +
         geom_line(aes(col = State2)) + facet_wrap(~ Census_Region) +
         ylab("Contribution to LE Gap (%)") +
         xlab("Year") +
         geom_text(data = subset(cod.contributions, Year3 == 2000 & Sex2 == "Male" & Cause.of.death == "All other causes"),
         aes(label = stabbrs), check_overlap = T, size = 2.5))
```

**Figure 8g: Different way to portray the above data for females**

```{r figure8g, fig.align="center", fig.height=8, fig.width=9, echo=F}
for (cod in levels(cod.contributions$Cause.of.death)) {
  print(ggplot(subset(cod.contributions, Sex2 == "Female" & Cause.of.death == cod), aes(x = Year3, y = State2)) + 
          geom_tile(aes(fill = C_x_COD), col = "white") +
          facet_wrap(~ Census_Region, scales = "free_y") + 
          scale_fill_viridis() + theme_minimal() + 
          ylab("Contribution to LE Gap (years)") +
          xlab("Year") + ggtitle(cod))
}
```

-add CIs when I have them

###Discussion

###Supplemental Information

**eTable1: Cause of Death Recode**

| Broad cause of death     | Included causes of death                                                     |
|--------------------------|------------------------------------------------------------------------------|
| Cancers                   | Lip; Tongue; Salivary gland; Floor of mouth; Gum and other mouth; Nasopharnyx; Tonsil; Oropharynx; Hypopharynx; Other oral cavity and pharynx; Esophagus; Stomach; Small intestine; Colon excluding rectum; Rectum and rectosigmoid junction; Anus, anal canal and anorectum; Liver; Intrahepatic bile duct; Gallbladder; Other biliary; Pancreas; Retroperitoneum; Peritoneum, Omentum and mesentery; Other digestive organs; Nose, nasal cavity and middle ear; Larynx; Lung and bronchus; Pleura; Trachea, Mediastinum and other respiratory organs; Bones and joints; Soft tissue including heart; Melanoma of the skin; Non-melanoma skin; Breast; Cervix uteri; Corpus uteri; Uterus, NOS; Ovary; Vagina; Vulva; Other female genital organs; Prostate; Testis; Penis; Other male genital organs; Urinary bladder; Kidney and renal pelvis; Ureter; Other urinary organs; Eye and orbit; Brain and other nervous system; Thyroid; Other endocrine including thymus; Hodkin lymphoma; Myeloma; Acute lymphocytic leukemia; Chronic lymphocytic leukemia; Other lymphocytic leukemia; Acute myeloid leukemia; Acute monocytic leukemia; Chronic myeloid leukemia; Other myeliod/monocytic leukemia; Other acute leukemia; Aleukemic, Subleukemic and NOS; Miscellaneous malignant cancer. |
| Cardiovascular disease   | Diseases of heart; Hypertension without heart disease; Cerebrovascular diseases; Atherosclerosis; Aortic aneurysm and dissection; Other diseases of arteries, arterioles, capillaries. | 
| Communicable disease     | Tuberculosis; Syphilis; HIV (1987+), Septicemia; Other infectious and parasitic diseases; Pneumonia and influenza |
| Non-communicable disease | Diabetes Mellitus; Alzheimers (ICD9 and 10 only); Chronic obstructive pulmonary disease and allied conditions; Stomach and duodenal ulcers; Chronic liver disease and cirrhosis; Nephritis, Nephrotic Sydrome and Nephrosis.  |
| Injuries                 | Accidents and Adverse Effects; Suicide and Self-inflicted Injury; Homicide and Legal Intervention. |
| All other causes         | Complications of pregnancy, childbirth, puerperium; Congenital anomalies; Certain conditions originating in perinatal period; Symptoms, signs, and ill-defined conditions; Other cause of death. |

**Life table and decomposition methodology**

**Life table and decomposition user-written functions**
