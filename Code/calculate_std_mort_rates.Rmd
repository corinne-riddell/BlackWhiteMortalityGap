---
title: "Untitled"
output: html_document
---


```{r load_libraries}
library(dplyr)
library(purrr)
library(ggplot2)
library(stringr)
library(reshape2)
library(grid)
library(gridExtra)

source("/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Code/life_expectancy_functions.R")

```

```{r read_in_posterior_results_samples_1_and_2}
#this take a long time (a few hours!)
load("~/BW_results/results_set_1.Rdata")
r.All.set1 <- r.All %>% filter(post.samp %in% c(1,2))

for(i in 2:8){
  print(i)
  load(paste0("~/BW_results/results_set_", i, ".Rdata"))
  assign(paste0("r.All.set", i), r.All %>% filter(post.samp %in% c(1,2)))
  rm(r.All)
}

r.All.post1.2 <- rbind(r.All.set1, r.All.set2, r.All.set3, r.All.set4, 
                      r.All.set5, r.All.set6, r.All.set7, r.All.set8)
```

```{r load_std_pop}
std.pop <- read.csv("~/BlackWhiteMortalityGap/Data/US_Standard_Population.csv")

std.pop <- std.pop %>% select(Age, US_Standard_2000) %>% filter(Age != "Total")

std.pop <- std.pop %>% mutate(age.weight = US_Standard_2000/1000000)

std.pop <- std.pop %>% mutate(age_minbin = 0*(Age == "00 years") + 1*(Age == "01-04 years") + 5*(Age == "05-09 years") +
                     10*(Age == "10-14 years") + 15*(Age == "15-19 years") + 20*(Age == "20-24 years") +
                     25*(Age == "25-29 years") + 30*(Age == "30-34 years") + 35*(Age == "35-39 years") +
                     40*(Age == "40-44 years") + 45*(Age == "45-49 years") + 50*(Age == "50-54 years") +
                     55*(Age == "55-59 years") + 60*(Age == "60-64 years") + 65*(Age == "65-69 years") +
                     70*(Age == "70-74 years") + 75*(Age == "75-79 years") + 80*(Age == "80-84 years") +
                     85*(Age == "85+ years"))
```

```{r merge_and_calculated_age_stdized_mortality}
r.All.post1.2 <- merge(r.All.post1.2, std.pop, by = "age_minbin")

#returns dataset with new variable "age.std.mortality.rate" 
mortality.rates <- r.All.post1.2 %>% 
  group_by(post.samp, state.n, year.n, race.n, sex.n, COD) %>% 
  arrange(age_minbin) %>%
  summarise(age.std.mortality.rate = sum(age.weight*smoothed_rate), #the sum is across age bins
            race = first(race),
            sex = first(sex),
            state = first(state))

```

```{r tidy_mortality.rates}
COD.levels <- c("Cardiovascular", "Cancers", "Communicable", 
                "Non-communicable", "Injuries", "All other causes")

mortality.rates$COD <- factor(mortality.rates$COD, COD.levels)

mortality.rates <- add_Census_Division(mortality.rates, state)
mortality.rates <- add_Census_Region(mortality.rates, state)
mortality.rates$stabbrs <- state.abb[match(mortality.rates$state, state.name)]
mortality.rates$year <- mortality.rates$year.n + 1968
mortality.rates$rate.per.100k <- mortality.rates$age.std.mortality.rate*100000
```

```{r save_mortality_dataset}
#write.csv(r.All.post1.2, "~/BlackWhiteMortalityGap/Data/states_combined_post_samp_1_2.csv")
write.csv(mortality.rates, "~/BlackWhiteMortalityGap/Data/mortality_rates.csv")
```

```{r calculate_difference_in_mortality}
mortality.rates.white <- mortality.rates %>% filter(race == "White") %>% 
  select(sex, state, year, COD, post.samp, age.std.mortality.rate, rate.per.100k) %>%
  rename(age.std.mortality.rate.white = age.std.mortality.rate,
         rate.per.100k.white = rate.per.100k)

mortality.rates.black <- mortality.rates %>% filter(race == "Black") %>% 
  rename(age.std.mortality.rate.black = age.std.mortality.rate,
         rate.per.100k.black = rate.per.100k)  

mortality.rates.wide <- merge(mortality.rates.black, mortality.rates.white, by = c("post.samp", "sex", "state", "year", "COD"))

mortality.rates.wide <- mortality.rates.wide %>% mutate(rate.difference = rate.per.100k.black - rate.per.100k.white)

write.csv(mortality.rates.wide, "/Users/corinneriddell/Documents/repos/BlackWhiteMortalityGap/Data/mortality_rates_wide.csv")
```


