---
title: "Untitled"
output: html_document
---


```{r load_libraries}
library(dplyr)
library(purrr)
library(ggplot2)
library(stringr)
library(reshape2)
library(grid)
library(gridExtra)
```

```{r}
load("~/BW_results/results_set_1.Rdata")
r.All.set1 <- r.All %>% filter(post.samp %in% c(1,2))

for(i in 2:8){
  print(i)
  load(paste0("~/BW_results/results_set_", i, ".Rdata"))
  assign(paste0("r.All.set", i), r.All %>% filter(post.samp %in% c(1,2)))
  rm(r.All)
}

r.All.post1.2 <- rbind(r.All.set1, r.All.set2, r.All.set3, r.All.set4, 
                      r.All.set5, r.All.set6, r.All.set7, r.All.set8)
```

```{r load_std_pop}
std.pop <- read.csv("~/BlackWhiteMortalityGap/Data/US_Standard_Population.csv")

std.pop <- std.pop %>% select(Age, US_Standard_2000) %>% filter(Age != "Total")

std.pop <- std.pop %>% mutate(age.weight = US_Standard_2000/1000000)

std.pop <- std.pop %>% mutate(age_minbin = 0*(Age == "00 years") + 1*(Age == "01-04 years") + 5*(Age == "05-09 years") +
                     10*(Age == "10-14 years") + 15*(Age == "15-19 years") + 20*(Age == "20-24 years") +
                     25*(Age == "25-29 years") + 30*(Age == "30-34 years") + 35*(Age == "35-39 years") +
                     40*(Age == "40-44 years") + 45*(Age == "45-49 years") + 50*(Age == "50-54 years") +
                     55*(Age == "55-59 years") + 60*(Age == "60-64 years") + 65*(Age == "65-69 years") +
                     70*(Age == "70-74 years") + 75*(Age == "75-79 years") + 80*(Age == "80-84 years") +
                     85*(Age == "85+ years"))
```

```{r merge}
r.All.post1.2 <- merge(r.All.post1.2, std.pop, by = "age_minbin")

mortality.rates <- r.All.post1.2 %>% 
  group_by(post.samp, state.n, year.n, race.n, sex.n, COD) %>% 
  arrange(age_minbin) %>%
  summarise(age.std.mortality.rate = sum(age.weight*smoothed_rate),
            race = first(race),
            sex = first(sex),
            state = first(state))

ggplot(subset(mortality.rates, post.samp == 1 & state == "Alabama"), aes(y = age.std.mortality.rate, x = year.n)) + 
  geom_line(aes(col = COD)) + facet_grid(race ~ sex)

write.csv(r.All.post1.2, "~/BlackWhiteMortalityGap/Data/states_combined_post_samp_1_2.csv")
write.csv(mortality.rates, "~/BlackWhiteMortalityGap/Data/mortality_rates.csv")
```

