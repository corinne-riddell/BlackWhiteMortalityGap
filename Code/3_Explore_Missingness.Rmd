---
title: "3_Explore_Missingness"
author: "Corinne Riddell"
date: "1/19/2017"
output: html_document
---

###Initial graphs on missing data
Notes on Figure 1 (below):

- Figure 1 is sorted by size of the black population in the state in 2013. This is so you can see how missingness is a function of population size. We expect that states with less black people will have more missing data and more counts of exactly zero. Thus, states with the biggest populations (of blacks and whites) will "hold constant" the effect of population size on the amount of missing data.

- The first panels you see in Figure 1 (below) are for the states with the smallest black populations. For whites, the amount of missing data increases in age until about 40 years old, and then decreases. For blacks, the amount of missing data is very low across age. This seemed strange to me at first, but then I remembered that the data is not missing if the count is equal to 0, which will be the case for many strata in these states with the lowest black population.

- As you read left to right (as the black population size increases by state), the trends in missing data across age look more similar by race, although blacks appear to have more missing data in individuals < 30 years old for the states with the most black people.

**Figure 1: Proportion missing by State (panel) and Age group (x-axis), ordered by increasing size of black population in 2013**
```{r bystate, fig.width = 12, fig.height = 37, echo=F}
bystate <- 
  dat %>%
  group_by(State2, Race2, Age2) %>%
  summarise(prop.missing = mean(is.na(Count)))

#recode a new count variable that "counts the missing data" so that these rows are used when calculating the % of data == 0.
dat$Count2 <- dat$Count
dat$Count2[is.na(dat$Count) == T] <- 1

bystate2 <- 
  dat %>%
  group_by(State2, Race2, Age2) %>%
  summarise(prop.zero = mean(Count2 == 0))

bystate <- merge(bystate, bystate2, by=c("State2", "Race2", "Age2"))

#calculate the size of the black population in 2013 by State
bystate.bpop <- 
  dat %>%
  filter(COD2 == "Cancers" & Year2 == 2013 & Race2 == "Black") %>% #to stop repeats of the population size
  group_by(State2) %>%
  summarize(pop_by_race = sum(as.numeric(Population)))

#calculate the size of the black population in 1969 by State
bystate.bpop.1969 <- 
  dat %>%
  filter(COD2 == "Cancers" & Year2 == 1969 & Race2 == "Black") %>% #to stop repeats of the population size
  group_by(State2) %>%
  summarize(pop_by_race_1969 = sum(as.numeric(Population)))

bystate <- merge(bystate, bystate.bpop, by = "State2", all.x = T)
bystate <- merge(bystate, bystate.bpop.1969, by = "State2", all.x = T)
bystate$State3 <- reorder(bystate$State2, bystate$pop_by_race)

ggplot(bystate, aes(x = Age2, y = prop.missing)) + 
  geom_point(aes(col=Race2)) + facet_wrap(~ State3, ncol = 4) +
  theme_bw(base_size = 11) +
  theme(legend.position="top") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("Proportion Missing (%)") +
  xlab("Age group")

ggplot(subset(bystate, Age2 == "<1 year"), aes(pop_by_race_1969, pop_by_race)) + geom_point() + geom_abline(intercept = 0, slope = 1)

unique(bystate$State2[bystate$Age2 == "<1 year" & bystate$pop_by_race_1969 < 10000])
```

Notes on Figure 2 (below):

- Figure 2 examines the proportion of counts equal to zero. The purpose of this examination is to visually confirm that there are higher proportions of zero counts in the states with the least amount of blacks. This is very clear when viewing the figure.

- Question - any explantion for why the portion of zeroes stays relatively higher in blacks vs. whites in the states with the most blacks (within the younger age groups)?

**Figure 2: Proportion zero by State (panel) and Age group (x-axis), ordered by increasing size of black population in 2013**

```{r zero_by_state, fig.width = 12, fig.height = 37, echo=F}
ggplot(bystate, aes(x = Age2, y = prop.zero)) + 
  geom_point(aes(col=Race2)) + facet_wrap(~ State3, ncol = 4) +
  theme_bw(base_size = 11) +
  theme(legend.position="top") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("Proportion Zero (%)") +
  xlab("Age group") 
```

###Other plots (less interesting/informative)

**How is missingness related to age, race, and sex?**

```{r missing_data, fig.width = 10, fig.height = 5, echo=F}
#table(is.na(dat$Count))

table1.whitemale <- round(prop.table(table(is.na(dat$Count[dat$RaceSex == "White Male"]), 
                                           dat$Age2[dat$RaceSex == "White Male"]),2)*100,2)
table1.blackmale <- round(prop.table(table(is.na(dat$Count[dat$RaceSex == "Black Male"]), 
                                           dat$Age2[dat$RaceSex == "Black Male"]),2)*100,2)
table1.whitefemale <- round(prop.table(table(is.na(dat$Count[dat$RaceSex == "White Female"]), 
                                           dat$Age2[dat$RaceSex == "White Female"]),2)*100,2)
table1.blackfemale <- round(prop.table(table(is.na(dat$Count[dat$RaceSex == "Black Female"]), 
                                           dat$Age2[dat$RaceSex == "Black Female"]),2)*100,2)

miss1 <- data.frame("white.male" = table1.whitemale[2, ], 
                    "black.male"= table1.blackmale[2, ],
                    "white.female" = table1.whitefemale[2, ], 
                    "black.female"= table1.blackfemale[2, ],
                    "age" = names(table1.whitemale[2, ]))
miss1$age <- factor(miss1$age, levels(miss1$age)[c(1, 2, 11, 3:10, 12:20)])

miss1 <- gather(miss1, racesex, missingness, c(white.male, black.male, white.female, black.female))

ggplot(miss1, aes(x = age, y = missingness)) + geom_point() + geom_point(aes(col=racesex)) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("Proportion Missing (%)") +
  xlab("Age group")
```

**Let's look at the proportion with 0's**

```{r zero_data, fig.width = 10, fig.height = 5, echo=F}
table2.whitemale <- round(prop.table(table(dat$Count[dat$RaceSex == "White Male"]==0, 
                                       dat$Age2[dat$RaceSex == "White Male"]),2)*100,2)
table2.blackmale <- round(prop.table(table(dat$Count[dat$RaceSex == "Black Male"]==0, 
                                       dat$Age2[dat$RaceSex == "Black Male"]),2)*100,2)
table2.whitefemale <- round(prop.table(table(dat$Count[dat$RaceSex == "White Female"]==0, 
                                       dat$Age2[dat$RaceSex == "White Female"]),2)*100,2)
table2.blackfemale <- round(prop.table(table(dat$Count[dat$RaceSex == "Black Female"]==0, 
                                       dat$Age2[dat$RaceSex == "Black Female"]),2)*100,2)

miss2 <- data.frame("whitemale" = table2.whitemale[2, ], 
                    "blackmale"= table2.blackmale[2, ],
                    "whitefemale" = table2.whitefemale[2, ], 
                    "blackfemale"= table2.blackfemale[2, ],
                    "age" = names(table2.blackmale[2, ]))

miss2$age <- factor(miss2$age, levels(miss2$age)[c(1, 2, 11, 3:10, 12:20)])

miss2 <- gather(miss2, racesex, zeroes, c(whitemale, blackmale, whitefemale, blackfemale))

ggplot(miss2, aes(x = age, y = zeroes)) + geom_point() + geom_point(aes(col=racesex)) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("Proportion Zero (%)") +
  xlab("Age group")
```

**Missing or zero (which is equivalent to < 10)**

```{r miss_or_zero_data, fig.width = 10, fig.height = 5, echo=F}
dat$miss_or_zero <- F
dat$miss_or_zero[dat$Count == 0 | is.na(dat$Count) == T] <- T

table3.whitemale <- round(prop.table(table(dat$miss_or_zero[dat$RaceSex == "White Male"]==T, 
                                      dat$Age2[dat$RaceSex == "White Male"]),2)*100,2)
table3.blackmale <- round(prop.table(table(dat$miss_or_zero[dat$RaceSex == "Black Male"]==T, 
                                       dat$Age2[dat$RaceSex == "Black Male"]),2)*100,2)
table3.whitefemale <- round(prop.table(table(dat$miss_or_zero[dat$RaceSex == "White Female"]==T, 
                                       dat$Age2[dat$RaceSex == "White Female"]),2)*100,2)
table3.blackfemale <- round(prop.table(table(dat$miss_or_zero[dat$RaceSex == "Black Female"]==T, 
                                       dat$Age2[dat$RaceSex == "Black Female"]),2)*100,2)

miss3 <- data.frame("whitemale" = table3.whitemale[2, ], 
                    "blackmale"= table3.blackmale[2, ],
                    "whitefemale" = table3.whitefemale[2, ], 
                    "blackfemale"= table3.blackfemale[2, ],
                    "age" = names(table3.blackmale[2, ]))

miss3$age <- factor(miss3$age, levels(miss3$age)[c(1, 2, 11, 3:10, 12:20)])

miss3 <- gather(miss3, racesex, miss_or_zero, c(whitemale, blackmale, whitefemale, blackfemale))

ggplot(miss3, aes(x = age, y = miss_or_zero)) + geom_point() + geom_point(aes(col=racesex)) +
  theme_bw(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("Proportion Missing or Zero (%)") +
  xlab("Age group")
```

```{r explore_data2, fig.width = 10, fig.height = 5, echo=F, eval=F}

summary(dat$Count)
ggplot(subset(dat, Count>0), aes(x = Count)) + geom_histogram(binwidth=100)

ggplot(subset(dat, State2=="Louisiana"), aes(x = Population, y = Count)) + 
  geom_point(aes(col=RaceSex), alpha=0.2) +
  facet_wrap(~COD2) + theme_bw()

```
