---
title: "How to make an abridged life table and calculate life expectancy"
author: "Corinne Riddell"
date: "September 15, 2016"
output: html_document
bibliography: "/Users/corinneriddell/Documents/repos/BlackWhiteGap/papers/bibliography.bib"
---

##What is a life table?
"A life table is a systematic way of keeping track of the mortality experience of a group." [@selvin_text, Chapter 9 Life Tables: An Introduction].

**Cohort life table**

A cohort life table is constructed by following a cohort of individuals through time and recording their exact age at death for all members of the cohort [@selvin_text]. For example, you could take the cohort of individuals born in 1998 in Montreal and each member's year of death. However, this would require waiting until the last member died and would therefore take a very long time.

**Current life table**

As a practical alternative, a life table can be made using current mortality rates for a population. This is called a current life table [@selvin_text] or a period life table [@preston_demography_text].

**Complete vs abridged life table**

If mortality rates can be calculated for each age, then the life table is called complete, compared to life tables calculated based on data categorized by age groupings (i.e., <1 years old, 1-4 years old, 5-9 years old, etc) which are called abridged.

**Elements used to construct a complete (current) life table**

1. Age interval ($x$ to $x+1$): For a complete life table all age groups are 1 year in length, except for the last group, which is left open-ended (e.g, 85 years or older).

2. Number alive ($l_x$): The number of individuals alive at age $x$. For every interval, $l_x$ defined the population at risk of death during the interval. To begin, we set $l_0=100000$.

3. Number of deaths ($d_x$): The number of individuals who die between the ages of $x$ and $x+1$.

4. Probability of death ($q_x$): Prob(death before x + 1 | alive at x) = $d_x/l_x$.

5. Number of years lived ($L_x$): The person-time-at-risk of death lived by the cohort between ages $x$ and $x+1$. 
    a. Each individual who does not die during the interval contributes 1 person-year, and those who die contribute the proportion of the year up until their death (which is approximated to be 9% of the year for the <1 age group and half a year (50%) for all other groups). This "average time contributed by those who die" is denoted by $\bar{a_x}$.
    b. Therefore, $L_x=(l_x-d_x)+\bar{a_x}d_x$.
  
6. Cumulative time lived ($T_x$): This is the accumulation of person-time-at-risk at age x and beyond -- the total number of person years lived by those alive at age $x$.

7. Expectation of life ($e_x$): The average number of additional years expected to be lived by those individuals alive at age $x$. $e_x=T_x/l_x$.

To construct the life table, we first need to calculate the probabilities of death, $q_x$. To find a formula for $q_x$ we first write the formula for $R_x$, the age-specific mortality rate, and re-arrange to isolate $q_x$:

$R_x=d_x/L_x$ 

$R_x=d_x/(l_x-d_x)+\bar{a_x}d_x$, dividing the numerator and denominator by $l_x$:

$R_x=q_x/(1-q_x)+\bar{a_x}q_x$, rearranging to solve for $q_x$:

$q_x=\frac{R_x}{1+(1-\bar{a_x})R_x}$.

Observed mortality rates $R_x$ can therefore be used to calculate the probability of dying within each age-specific interval. The observed mortality rates are calculated as $d_x/Pop_x$, where $Pop_x$ is the number of individuals alive during age $x$. While this looks like a proportion, it calculates a *rate* when we assume the population is stationary, thereby implying there are $Pop_x$ person-years at risk of death during the age bracket. 

After $q_x$ is calculated based on $R_x$, all of the other quantities defined above can also be calculated, except for the $L_x$, the number of years lived, in the last age group. In this age group, $\bar{a_x}$ is unknown, and all the individuals in the age bracket will die (i.e., $q_x=1$). Because $d_x/L_x=R_x$ and $d_x=l_x$ in this age group, we can substitute $l_x$ for $d_x$ and write $l_x/L_x=R_x$, implying that $L_x=l_x/R_x$ in this age group.

##Assumptions of the life table

1. The number of births occurring each year is constant.
2. Deaths are uniformly distributed during the interval after 1 years old.
3. There is no population growth.

Together, these assumptions imply that the population must be stationary.


**Construction of an abridged (current) life table**

Recall that an abridged life table includes age intervals that are longer than a year. In practice, these intervals are often 5 years in length and can be represented by $n_x$, where $x$ is the age at the beginning of the interval. The formula for $q_x$ can be generalized to this context, where: $q_x=\frac{n_xR_x}{1+(1-\bar{a_x})n_xR_x}$.

**Derivation of the formula for $q_x$ when the life table is abridged**

This derivation was modified from the Preston demography text [@preston_demography_text]. Note that in the Preston book $a_x$ represents *person-years* not the proportion of the year, which is why the formulas look different (because we have to write $n_x\bar{a_x}$ in place of Preston's $a_x$).

We start with the simple formula for q_x. As before:
$q_x=d_x/l_x$.

Now, $L_x = n_x(l_x - d_x) + n_x\bar{a_x}d_x$

$L_x = n_xl_x - n_xd_x + n_x\bar{a_x}d_x$

$l_x = \frac{L_x + n_xd_x - n_x\bar{a_x}d_x}{n_x}$

$l_x = \frac{L_x + d_xn_x(1 - \bar{a_x})}{n_x}$

We can then substitute this expression for $l_x$ into the equation for $q_x$:

$q_x=\frac{d_x}{l_x}$

$q_x=\frac{d_xn_x}{L_x + d_xn_x(1 - \bar{a_x})}$, and dividing numerator and denominator by $L_x$, we get

$q_x=\frac{R_xn_x}{1 + R_xn_x(1 - \bar{a_x})}$.

**An example**

This data was used in a previously published paper [@auger2014mortality]. We use it to show how the life expectancy function works.

First, I create the dataset in R:
```{r create_dataset}
canada.men <- data.frame("ages" = c(0, 1, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90),
                         "obs.deaths" = c(4054, 625, 445, 622, 2568, 3770, 3434, 3681, 5155, 8449, 13421, 19371, 
                                          25448, 31465, 37441, 48796, 64763, 72512, 60109, 43812),
                         "obs.popn" = c(719953, 2835604, 3654546, 4071400, 4464549, 4564679, 4296613, 4237402,
                                        4532151, 5085092, 5163532, 4597916, 3937984, 3120981, 2323629, 1862971,
                                        1499907, 997492, 492445, 196109))

quebec.men <- data.frame("ages" = c(0, 1, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90), 
                         "obs.deaths" = c(1057, 164, 116, 176, 659, 956, 1056, 1110, 1498, 2470, 4116, 6054, 8426,
                                          11175, 13558, 16567, 21349, 22396, 16851,10878),
                         "obs.popn" = c(215200, 789710, 1008266, 1179423, 1249360, 1261780, 1349857, 1293521,
                                        1313834, 1551684, 1622835, 1485249, 1288014, 1077253, 796557, 609341, 
                                        476211, 300506, 134353, 49678))
```

I then add a column that denotes how many years are in each age bracket:
```{r add_n_x}
canada.men$n_x <- 5
canada.men$n_x[canada.men$ages == 0] <- 1
canada.men$n_x[canada.men$ages == 1] <- 4

quebec.men$n_x <- 5
quebec.men$n_x[quebec.men$ages == 0] <- 1
quebec.men$n_x[quebec.men$ages == 1] <- 4

head(canada.men)
head(quebec.men)

cod.props <- read.csv("/Users/corinneriddell/Documents/repos/BlackWhiteGap/working_teaching_examples/auger_cod_proportions.csv")

```

This source file contains the life expectancy functions used in this project:
```{r load_functions}
source("/Users/corinneriddell/Documents/repos/BlackWhiteGap/Code/life_expectancy_functions.R")
```

```{r calculate_life_expectancy}
life.table.cm <- life.table(data = canada.men, age.groups = "ages", num.ages.in.group = "n_x", death.counts = "obs.deaths", population.counts = "obs.popn")

round(life.table.cm, 2)

life.table.qm <- life.table(data = quebec.men, age.groups = "ages", num.ages.in.group = "n_x", death.counts = "obs.deaths", population.counts = "obs.popn")

round(life.table.qm, 2)
```

```{r calc_age_decomp}
age_decomp <- le_age_decomp(life.table.qm, life.table.cm)
age_decomp
#check:
sum(age_decomp$C_x)
age_decomp$Life_Expectancy_2[age_decomp$Ages ==0] - age_decomp$Life_Expectancy_1[age_decomp$Ages ==0]

#also compare to the decomposition if the data is entered in the reverse order:
age_decomp2 <- le_age_decomp(life.table.cm, life.table.qm)
age_decomp2
#check:
sum(age_decomp2$C_x)
age_decomp2$Life_Expectancy_2[age_decomp2$Ages ==0] - age_decomp2$Life_Expectancy_1[age_decomp2$Ages ==0]

```

```{r calc_cod_decomp}
canada.cod.decomp <- cause_of_death_decomp(life.table1 = life.table.qm, life.table2 = life.table.cm, decomp.table = age_decomp,
                      cod.table = cod.props,age.colname.cod.table = "Age", COD.colname.cod.table = "cod", 
                      prop1.colname.cod.table = "prop1", prop2.colname.cod.table = "prop2")

cod.contribution$Cause.of.death <- factor(cod.contribution$Cause.of.death, 
                                          levels = cod.contribution$Cause.of.death[order(cod.contribution$cod.contribution,
                                                                                         decreasing = T)])

ggplot(cod.contribution, aes(x = Cause.of.death, y = cod.contribution)) + 
  geom_point() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_abline(intercept = 0, slope = 0)
```

**A second example**

In this example we use the data that Sam entered into Stata to illustrate the life expectancy concept to me. I'll replicate the life table here to ensure that I can arrive at the same results as he does in Stata.

```{r lifetable_cali_complete}
cali.complete <- data.frame("ages" = c(0:15), "nx" = rep(1,16),
                         "obs.deaths" = c(1635, 64, 41, 22, 41, 55, 42, 58, 44, 52, 48, 60, 52, 82, 129, 23300), #last number is fictitious
                         "obs.popn" = c(123342, 111520, 109200, 108749, 105698, 110548, 106857, 112184, 116423,
                                        132952, 134266, 128938, 125502, 128212, 132775, 143600))

head(cali.complete)

life.table(data = cali.complete, age.groups = "ages", num.ages.in.group = "nx", 
           death.counts = "obs.deaths", population.counts = "obs.popn")

cali.complete$avelived <- 0.5
cali.complete$avelived[cali.complete$ages==0] <- 0.1

life.table(data = cali.complete, age.groups = "ages", num.ages.in.group = "nx", ave.prop.lived = "avelived",
           death.counts = "obs.deaths", population.counts = "obs.popn")
```

```{r lifetable_cali_abridged, warning=F, message=F}
cali.complete$group <- cut(cali.complete$ages, breaks=c(0, 1, 5, 10, 15, 20), 
                           labels = c("<1 years old", "1-4 years old", "5-9 years old", 
                                      "10-14 years old", "15 or older"), include.lowest = T, right = F)

table(cali.complete$group, cali.complete$ages)

library(dplyr)
cali.abridged <- cali.complete %>% group_by(group) %>% 
                                   summarise(nx = sum(nx), ages = first(group), popn = sum(obs.popn), deaths = sum(obs.deaths),
                                             avelived = first(avelived))

cali.abridged

data.frame(life.table(data = cali.abridged, age.groups = "ages", num.ages.in.group = "nx", 
           death.counts = "deaths", population.counts = "popn"))


data.frame(life.table(data = cali.abridged, age.groups = "ages", num.ages.in.group = "nx", 
           death.counts = "deaths", population.counts = "popn", ave.prop.lived = "avelived"))
```          

```{r alabama_example}
#load("Data/alabama_only.Rdata")
load("/Users/corinneriddell/Documents/repos/BlackWhiteGap/Data/alabama_only.Rdata")
#example data
alabama.by.strata <- 
  dat.clean.alabama %>% group_by(Year2, RaceSex, Age2) %>%
  arrange(RaceSex, Year2, Age2) %>%
  mutate(nx = 1*(Age2 == "<1 year") + 4*(Age2 == "1-4 years") + 5*(Age2 != "<1 year" & Age2 != "1-4 years")) %>%
  summarise(total_deaths5 = sum(Count_md5),
            Population = first(Population), 
            Race2 = first(Race2), 
            Sex2 = first(Sex2), 
            StateYearRaceSex = first(StateYearRaceSex),
            nx = first(nx))

first.strata <- alabama.by.strata[alabama.by.strata$StateYearRaceSex == "Alabama.1969.White.Male", ]
second.strata <- alabama.by.strata[alabama.by.strata$StateYearRaceSex == "Alabama.1969.Black.Male", ]

alabama.by.strata.cod <- dat.clean.alabama %>% group_by(Year2, RaceSex, Age2) %>%
                                               arrange(RaceSex, Year2, Age2) %>%
                                               mutate(total_deaths5 = sum(Count_md5),
                                                      cod_prop_death5 = Count_md5/total_deaths5)

first.strata.cod <- alabama.by.strata.cod[alabama.by.strata.cod$StateYearRaceSex == "Alabama.1969.White.Male", ]
second.strata.cod <- alabama.by.strata.cod[alabama.by.strata.cod$StateYearRaceSex == "Alabama.1969.Black.Male", ]

cod.tab.alabama.male.1969 <- first.strata.cod %>% ungroup() %>%
                                                  select(Age2, COD2, cod_prop_death5) %>%
                                                  rename(prop2 = cod_prop_death5)

cod.tab.alabama.male.1969$prop1 <- second.strata.cod$cod_prop_death5
cod.tab.alabama.male.1969 <- cod.tab.alabama.male.1969 %>% arrange(COD2, Age2)



ggplot(cod.tab.alabama.male.1969, aes(x=COD2, y=prop1)) + 
  geom_point(aes(col="White")) + geom_point(aes(y=prop2, col="Black")) +
  scale_y_continuous(name = "Proportion dying from specified cause") +
  facet_wrap(~Age2) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
system.time(life.table.whites <- data.frame(life.table(data = first.strata, age.groups = "Age2", num.ages.in.group = "nx", death.counts = "total_deaths5", population.counts = "Population")))

life.table.blacks <- data.frame(life.table(data = second.strata, age.groups = "Age2", num.ages.in.group = "nx", death.counts = "total_deaths5", population.counts = "Population"))

life.table.whites[, c("Age2", "total_deaths5", "Population", "R_x", "q_x", "l_x", "d_x", "L_x", "T_x", "e_x")]

system.time(
for(stratum.id in levels(droplevels(alabama.by.strata$StateYearRaceSex))) {
  assign(paste0("lt.", as.character(stratum.id)), 
         life.table(data = subset(alabama.by.strata, StateYearRaceSex == stratum.id), 
                                  age.groups = "Age2", num.ages.in.group = "nx", 
                                  death.counts = "total_deaths5", population.counts = "Population"))
}
)

alabama_age_decomp <- le_age_decomp(life.table.blacks, life.table.whites, "Age2")
alabama_age_decomp

ggplot(alabama_age_decomp, aes(y = C_x, x = Ages)) + geom_point() + scale_y_continuous("Contribution of Age to Gap")
sum(alabama_age_decomp$C_x)
life.table.whites$e_x[1] - life.table.blacks$e_x[1]

ggplot(alabama_age_decomp, aes(y = Life_Expectancy_1, x = Ages)) + geom_point(aes(col="Black")) + scale_y_continuous("Life Expectancy (Yrs)") +
  geom_point(aes(y = Life_Expectancy_2, col="White"))
```

##References